<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher ‚Äî Design Thinking Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,400;0,500;0,600;0,700;0,800&family=Lilita+One&display=swap" rel="stylesheet">
<style>
:root{--bg:#f0fdf4;--surface:#fff;--surface-2:#f7f8fc;--surface-3:#eef1f8;--border:#e0e4ef;--border-focus:#a5b4fc;--text:#1e293b;--text-muted:#64748b;--text-dim:#94a3b8;--shadow:0 2px 12px rgba(100,116,180,.08);--shadow-hover:0 6px 24px rgba(100,116,180,.14);--empathize:#ec4899;--define:#f97316;--ideate:#eab308;--prototype:#22c55e;--test:#3b82f6;--empathize-light:#fce7f3;--define-light:#fff7ed;--ideate-light:#fefce8;--prototype-light:#f0fdf4;--test-light:#eff6ff;--accent:#6366f1;--accent-light:#e0e7ff;--accent-glow:rgba(99,102,241,.15);--group-color:#3b82f6;--personal-color:#ec4899;--teacher:#7c3aed;--teacher-light:#f5f3ff;--teacher-border:#ddd6fe;--radius:14px;--radius-lg:20px}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}h1,h2,h3,.logo-text{font-family:'Lilita One',cursive;font-weight:400}
::-webkit-scrollbar{width:7px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}@keyframes pop{0%{transform:scale(.95);opacity:0}100%{transform:scale(1);opacity:1}}@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.4}}@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}
.top-nav{position:sticky;top:0;z-index:100;background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px;height:58px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 1px 6px rgba(0,0,0,.04)}
.logo{display:flex;align-items:center;gap:10px}.logo-icon{width:34px;height:34px;background:linear-gradient(135deg,var(--empathize),var(--accent),var(--test));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;color:#fff}.logo-text{font-size:1.15rem}
.nav-right{display:flex;align-items:center;gap:10px}
.sync-status{display:flex;align-items:center;gap:6px;font-size:.72rem;font-weight:700;color:var(--text-dim);padding:4px 10px;background:var(--surface-2);border-radius:20px;border:1px solid var(--border)}.sync-dot{width:7px;height:7px;border-radius:50%;background:#22c55e;animation:pulse-dot 2s infinite}
.view-container{padding:28px 24px 60px;max-width:1200px;margin:0 auto;animation:fadeUp .4s}
.map-header{text-align:center;margin-bottom:28px}.map-header h1{font-size:2rem;background:linear-gradient(135deg,var(--empathize),var(--accent),var(--test));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px}.map-header p{color:var(--text-muted);font-size:.92rem;max-width:500px;margin:0 auto}
.week-selector{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:24px}.week-nav-btn{background:var(--surface);border:1px solid var(--border);width:34px;height:34px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;color:var(--text-muted);transition:all .2s}.week-nav-btn:hover{border-color:var(--accent);color:var(--accent)}.week-nav-btn:disabled{opacity:.3;cursor:not-allowed}.week-display{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:7px 22px;font-weight:700;font-size:.9rem;min-width:160px;text-align:center;box-shadow:var(--shadow)}.add-week-btn{background:var(--accent);color:#fff;border:none;padding:7px 16px;border-radius:10px;font-weight:700;font-size:.8rem;cursor:pointer;font-family:'Nunito',sans-serif}
.announcement-bar{background:linear-gradient(135deg,var(--teacher-light),#eef2ff);border:2px solid var(--teacher-border);border-radius:var(--radius);padding:14px 18px;margin-bottom:18px;display:flex;align-items:flex-start;gap:10px;animation:fadeUp .35s}.ann-icon{font-size:1.2rem;flex-shrink:0;margin-top:2px}.ann-content{flex:1}.ann-title{font-weight:800;font-size:.85rem;color:var(--teacher);margin-bottom:2px}.ann-text{font-size:.85rem;color:var(--text-muted);line-height:1.5}
.teacher-card{background:var(--surface);border:2px solid var(--teacher-border);border-radius:var(--radius-lg);padding:22px;margin-bottom:18px;box-shadow:var(--shadow)}.teacher-card h3{font-size:1.05rem;color:var(--teacher);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.t-input-group{margin-bottom:12px}.t-input-group label{font-size:.72rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:4px}.t-input,.t-textarea{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'Nunito',sans-serif;font-size:.88rem;color:var(--text);background:var(--surface-2)}.t-textarea{min-height:70px;resize:vertical;line-height:1.5}.t-input:focus,.t-textarea:focus{outline:none;border-color:var(--teacher)}
.t-btn{background:var(--teacher);color:#fff;border:none;padding:9px 20px;border-radius:10px;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif;font-size:.85rem}
.stage-toggle{display:flex;align-items:center;gap:8px;padding:9px 12px;background:var(--surface-2);border-radius:9px;margin-bottom:7px;border:1.5px solid var(--border)}.stage-toggle label{flex:1;font-weight:600;font-size:.88rem;display:flex;align-items:center;gap:7px;cursor:pointer}.stage-toggle input[type="checkbox"]{accent-color:var(--teacher);width:17px;height:17px}
.milestone-editor{padding:10px;background:var(--surface-2);border-radius:9px;margin-top:7px;border:1px solid var(--border)}.milestone-editor-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}.milestone-editor-row .t-input{flex:1}.weight-input{width:60px!important;text-align:center;flex:none!important}.remove-milestone-btn{background:none;border:none;color:#ef4444;cursor:pointer;font-size:1rem;padding:3px}.add-milestone-btn{background:none;border:1.5px dashed var(--teacher-border);color:var(--teacher);padding:6px 12px;border-radius:8px;cursor:pointer;font-family:'Nunito',sans-serif;font-weight:700;font-size:.8rem;width:100%}.add-milestone-btn:hover{background:var(--teacher-light)}
.progress-row{display:flex;align-items:center;gap:8px;font-size:.75rem}.progress-label{width:60px;font-weight:700;color:var(--text-muted)}.progress-bar{flex:1;height:7px;background:var(--surface-3);border-radius:4px;overflow:hidden}.progress-fill{height:100%;border-radius:4px;transition:width .5s}.progress-fill.ai-score{background:linear-gradient(90deg,#a78bfa,var(--teacher))}.progress-pct{width:34px;text-align:right;font-weight:800}
.tabs{display:flex;gap:3px;background:var(--surface-3);border-radius:10px;padding:3px;margin-bottom:14px;width:fit-content;border:1px solid var(--border)}.tab-btn{padding:7px 18px;border:none;background:none;color:var(--text-muted);border-radius:7px;cursor:pointer;font-size:.82rem;font-weight:700;transition:all .2s;font-family:'Nunito',sans-serif}.tab-btn.active{background:var(--accent);color:#fff}
.students-table{width:100%;border-collapse:collapse;font-size:.85rem}.students-table thead th{text-align:left;padding:8px;border-bottom:2px solid var(--border);font-weight:700;color:var(--text-muted)}.students-table tbody td{padding:8px;border-bottom:1px solid var(--border)}.students-table tbody tr:hover{background:var(--surface-2);cursor:pointer}
.group-card{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px;cursor:pointer;transition:all .2s}.group-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:var(--shadow-hover)}.group-card h4{font-size:.95rem;color:var(--teacher);margin-bottom:6px}
.student-card{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:10px;cursor:pointer;transition:all .2s}.student-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:var(--shadow-hover)}.student-card-header{display:flex;justify-content:space-between;align-items:center}.student-card-name{font-weight:700;color:var(--teacher)}.student-card-group{font-size:.75rem;color:var(--text-muted);padding:2px 8px;background:var(--surface-2);border-radius:6px;margin-top:4px;width:fit-content}
.back-btn{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:7px 16px;border-radius:10px;cursor:pointer;font-size:.82rem;font-weight:700;display:inline-flex;align-items:center;gap:6px;margin-bottom:16px;font-family:'Nunito',sans-serif;box-shadow:var(--shadow)}.back-btn:hover{border-color:var(--accent);color:var(--accent)}
.detail-view{display:none;animation:fadeUp .3s}.detail-view.active{display:block}
.sync-toast{position:fixed;bottom:20px;left:20px;background:var(--surface);border:1px solid var(--border);padding:8px 16px;border-radius:12px;font-size:.8rem;font-weight:700;z-index:200;box-shadow:var(--shadow-hover);opacity:0;transform:translateY(10px);transition:all .3s;pointer-events:none}.sync-toast.show{opacity:1;transform:translateY(0)}.sync-toast.saved{color:#16a34a;border-color:#86efac}.sync-toast.synced{color:#2563eb;border-color:#93c5fd}
.ai-toggle{position:fixed;right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#7c3aed);border:none;cursor:pointer;z-index:95;display:flex;align-items:center;justify-content:center;font-size:22px;color:#fff;box-shadow:0 4px 18px var(--accent-glow)}.ai-toggle:hover{transform:scale(1.08)}
.ai-panel{position:fixed;right:-420px;top:0;bottom:0;width:400px;background:var(--surface);border-left:1px solid var(--border);z-index:200;display:flex;flex-direction:column;transition:right .35s cubic-bezier(.4,0,.2,1);box-shadow:-4px 0 24px rgba(0,0,0,.08)}.ai-panel.open{right:0}
.ai-header{padding:12px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,#eef2ff,#fdf4ff)}.ai-header h3{font-family:'Lilita One',cursive;font-weight:400;font-size:1rem;display:flex;align-items:center;gap:7px;color:var(--accent)}.ai-close{background:var(--surface-3);border:none;color:var(--text-muted);cursor:pointer;width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:.95rem}.ai-close:hover{background:var(--border);color:var(--text)}
.ai-context{padding:6px 18px;background:var(--surface-2);font-size:.72rem;font-weight:600;color:var(--text-muted);border-bottom:1px solid var(--border)}
.ai-messages{flex:1;overflow-y:auto;padding:12px 18px;display:flex;flex-direction:column;gap:8px}.ai-msg{max-width:88%;padding:9px 13px;border-radius:12px;font-size:.85rem;line-height:1.5;animation:fadeUp .25s}.ai-msg.bot{background:var(--surface-2);border:1px solid var(--border);align-self:flex-start;border-bottom-left-radius:4px}.ai-msg.user{background:var(--accent);color:#fff;align-self:flex-end;border-bottom-right-radius:4px;font-weight:600}
.ai-suggestions{padding:6px 14px;display:flex;flex-wrap:wrap;gap:4px}.ai-suggestion{background:var(--surface-2);border:1px solid var(--border);color:var(--text-muted);padding:4px 11px;border-radius:20px;font-size:.72rem;cursor:pointer;font-family:'Nunito',sans-serif;font-weight:600}.ai-suggestion:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}
.ai-input-area{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:6px;background:var(--surface-2)}.ai-input{flex:1;background:var(--surface);border:1.5px solid var(--border);border-radius:9px;padding:8px 12px;color:var(--text);font-size:.85rem;font-family:'Nunito',sans-serif}.ai-input:focus{outline:none;border-color:var(--accent)}.ai-send{background:var(--accent);border:none;border-radius:9px;padding:0 14px;cursor:pointer;font-size:1.05rem;color:#fff;font-weight:800}
.typing-dots{display:inline-flex;gap:3px;padding:3px 0}.typing-dots span{width:6px;height:6px;background:var(--text-dim);border-radius:50%;animation:bounce 1.4s infinite}.typing-dots span:nth-child(2){animation-delay:.2s}.typing-dots span:nth-child(3){animation-delay:.4s}
.read-only-block{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:10px;animation:pop .3s}.block-content{font-size:.88rem;line-height:1.6;color:var(--text)}.block-photos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;margin-bottom:8px}.photo-thumb{aspect-ratio:1;border-radius:9px;overflow:hidden;border:1px solid var(--border)}.photo-thumb img{width:100%;height:100%;object-fit:cover}
.milestones-list{display:flex;flex-direction:column;gap:8px}.milestone-item-ro{background:var(--surface-2);padding:10px;border-radius:9px;border:1px solid var(--border)}.milestone-weight-ro{font-weight:800;color:var(--teacher);font-size:.85rem}.milestone-name-ro{font-weight:700;font-size:.88rem;margin-bottom:3px}.milestone-desc-ro{font-size:.8rem;color:var(--text-muted)}.loader{display:inline-block;width:12px;height:12px;border:2px solid var(--surface-3);border-top:2px solid var(--teacher);border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:768px){.view-container{padding:20px 16px;}.teacher-card{padding:16px}.ai-panel{width:100%;right:-100%}.top-nav{padding:0 12px}}
</style>
</head>
<body>
<nav class="top-nav">
  <div class="logo">
    <div class="logo-icon">üí°</div>
    <span class="logo-text">Teacher Dashboard</span>
  </div>
  <div class="nav-right">
    <div class="sync-status">
      <div class="sync-dot" id="syncDot"></div>
      <span id="syncLabel">Synced</span>
    </div>
    <span style="font-weight:700;font-size:.85rem" id="navName">Teacher</span>
    <a href="#" onclick="logout(); return false;" style="margin-left:8px;font-size:.75rem;font-weight:700;color:var(--text-muted);text-decoration:none">Log out</a>
  </div>
</nav>

<div class="view-container" id="mainContent"></div>

<button class="ai-toggle" id="aiToggle">ü§ñ</button>
<div class="ai-panel" id="aiPanel">
  <div class="ai-header">
    <h3>ü§ñ DT Coach</h3>
    <button class="ai-close" id="aiClose">‚úï</button>
  </div>
  <div class="ai-context">üí° Ask me anything about Design Thinking</div>
  <div class="ai-messages" id="aiMessages">
    <div class="ai-msg bot">Hey! üëã I'm your Design Thinking coach. Ask me anything!</div>
  </div>
  <div class="ai-suggestions" id="aiSuggestions">
    <button class="ai-suggestion" onclick="askAI(this.textContent)">How do I interview users?</button>
    <button class="ai-suggestion" onclick="askAI(this.textContent)">Help write a problem statement</button>
    <button class="ai-suggestion" onclick="askAI(this.textContent)">What makes a good prototype?</button>
  </div>
  <div class="ai-input-area">
    <input class="ai-input" id="aiInput" placeholder="Ask your DT Coach..." />
    <button class="ai-send" onclick="sendAI()">‚Üí</button>
  </div>
</div>

<div class="sync-toast" id="syncToast"></div>

<script>
// ===== CONFIG & STATE =====
const STAGES = [
  {id:'empathize',name:'Empathize',icon:'‚ù§Ô∏è',color:'#ec4899',bg:'#fce7f3',desc:'Research user needs through observation and interviews.'},
  {id:'define',name:'Define',icon:'üéØ',color:'#f97316',bg:'#fff7ed',desc:'Synthesize findings into a human-centered problem statement.'},
  {id:'ideate',name:'Ideate',icon:'üí°',color:'#eab308',bg:'#fefce8',desc:'Brainstorm creative ideas ‚Äî go wild!'},
  {id:'prototype',name:'Prototype',icon:'üîß',color:'#22c55e',bg:'#f0fdf4',desc:'Build a rough, testable version of your solution.'},
  {id:'test',name:'Test',icon:'üß™',color:'#3b82f6',bg:'#eff6ff',desc:'Get real feedback. Listen, observe, refine.'}
];

let config = { name: 'Teacher', group: 'Admin' };
let state = { currentWeek: 1, totalWeeks: 1, activeTab: 'dashboard', selectedGroup: null, selectedStudent: null };
let TD = { announcements: {}, weekConfigs: {} };

// ===== AUTH & INIT =====
async function authBootstrap() {
  try {
    const r = await fetch('/api/auth/me', { credentials: 'same-origin' });
    if (!r.ok) { window.location.href = '/login.html'; return; }
    const u = await r.json();
    if (u.role !== 'teacher' && !u.isTeacher && u.role !== 'admin') {
      window.location.href = '/login.html'; return;
    }
    config.name = u.name || config.name;
  } catch (e) {
    console.log('Auth check skipped (local dev)');
  }
}

function logout() {
  fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' }).then(() => {
    window.location.href = '/login.html';
  }).catch(() => { window.location.href = '/login.html'; });
}

// ===== STORAGE & HELPERS =====
function mId() { return 'b' + Date.now() + Math.random().toString(36).slice(2, 5); }
function gWK() { return 'week' + state.currentWeek; }
function gTC() {
  const w = gWK();
  if (!TD.weekConfigs[w]) {
    TD.weekConfigs[w] = {
      openStages: ['empathize'],
      announcement: '',
      stages: {}
    };
    STAGES.forEach(s => {
      TD.weekConfigs[w].stages[s.id] = {
        milestones: [
          { id: mId(), name: 'Complete initial research', desc: 'Document at least 2 user interactions', weight: 30 },
          { id: mId(), name: 'Visual documentation', desc: 'Upload photo evidence', weight: 20 },
          { id: mId(), name: 'Team collaboration', desc: 'All members contribute', weight: 25 },
          { id: mId(), name: 'Reflection', desc: 'Complete reflection', weight: 25 }
        ],
        rubric: 'Evaluate depth, evidence quality, collaboration, and critical thinking.'
      };
    });
  }
  return TD.weekConfigs[w];
}

function loadState() {
  let s = localStorage.getItem('dt-v4t');
  if (s) try { Object.assign(TD, JSON.parse(s)); } catch (e) {}
}

function saveState() {
  localStorage.setItem('dt-v4t', JSON.stringify(TD));
}

function autoSave() {
  saveState();
  showToast('saved', '‚úì Saved');
}

function showToast(t, m) {
  const el = document.getElementById('syncToast');
  el.className = 'sync-toast ' + t;
  el.textContent = m;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 1800);
}

function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ===== API CALLS =====
async function fetchStudents() {
  try {
    const r = await fetch('/api/teacher/students', { credentials: 'same-origin' });
    if (r.ok) return await r.json();
  } catch (e) {
    console.log('Students fetch failed:', e);
  }
  return [];
}

async function fetchGroups() {
  try {
    const r = await fetch('/api/teacher/groups', { credentials: 'same-origin' });
    if (r.ok) return await r.json();
  } catch (e) {
    console.log('Groups fetch failed:', e);
  }
  return [];
}

// ===== DASHBOARD TAB =====
function renderDashboard() {
  const tc = gTC();
  let html = `
    <div class="map-header">
      <h1>üë©‚Äçüè´ Teacher Dashboard</h1>
      <p>Configure tasks, milestones, and announcements for your class.</p>
    </div>

    <div class="week-selector">
      <button class="week-nav-btn" ${state.currentWeek <= 1 ? 'disabled' : ''} onclick="changeWeek(-1)">‚Äπ</button>
      <div class="week-display">Week ${state.currentWeek}</div>
      <button class="week-nav-btn" ${state.currentWeek >= state.totalWeeks ? 'disabled' : ''} onclick="changeWeek(1)">‚Ä∫</button>
      <button class="add-week-btn" onclick="addWeek()">+ New Week</button>
    </div>

    <div class="teacher-card">
      <h3>üì¢ Announcement</h3>
      <div class="t-input-group">
        <label>Message for students</label>
        <textarea class="t-textarea" placeholder="e.g. This week: user interviews!" oninput="gTC().announcement=this.value;autoSave()">${esc(tc.announcement)}</textarea>
      </div>
    </div>

    <div class="teacher-card">
      <h3>üîì Open Stages</h3>
      <p style="font-size:.82rem;color:var(--text-muted);margin-bottom:12px">Only checked stages are visible to students.</p>
      ${STAGES.map((s, i) => `
        <div class="stage-toggle">
          <label>
            <input type="checkbox" ${tc.openStages.includes(s.id) ? 'checked' : ''} onchange="tcToggle('${s.id}',this.checked)" />
            <span style="font-size:1rem">${s.icon}</span> Stage ${i+1}: ${s.name}
          </label>
        </div>
      `).join('')}
    </div>

    ${tc.openStages.map(sid => {
      const s = STAGES.find(x => x.id === sid);
      const sc = tc.stages[sid];
      const tw = sc.milestones.reduce((a, m) => a + m.weight, 0);
      return `
        <div class="teacher-card">
          <h3>${s.icon} ${s.name} ‚Äî Milestones <span style="font-size:.72rem;font-weight:600;color:${tw === 100 ? '#16a34a' : '#ef4444'};margin-left:6px">(${tw}%)</span></h3>
          ${sc.milestones.map((m, mi) => `
            <div class="milestone-editor">
              <div class="milestone-editor-row">
                <input class="t-input" value="${esc(m.name)}" placeholder="Name" onchange="tcUM('${sid}',${mi},'name',this.value)" />
                <input class="t-input weight-input" type="number" min="0" max="100" value="${m.weight}" onchange="tcUM('${sid}',${mi},'weight',parseInt(this.value))" />
                <span style="font-size:.78rem;color:var(--text-muted)">%</span>
                <button class="remove-milestone-btn" onclick="tcRM('${sid}',${mi})">‚úï</button>
              </div>
              <input class="t-input" value="${esc(m.desc)}" placeholder="Description" style="margin-top:3px" onchange="tcUM('${sid}',${mi},'desc',this.value)" />
            </div>
          `).join('')}
          <button class="add-milestone-btn" onclick="tcAM('${sid}')">+ Add Milestone</button>
          <div class="t-input-group" style="margin-top:12px">
            <label>AI Rubric</label>
            <textarea class="t-textarea" placeholder="How should AI evaluate..." oninput="gTC().stages['${sid}'].rubric=this.value;autoSave()">${esc(sc.rubric)}</textarea>
          </div>
        </div>
      `;
    }).join('')}
  `;

  document.getElementById('mainContent').innerHTML = html;
}

function tcToggle(sid, c) {
  const tc = gTC();
  if (c) {
    if (!tc.openStages.includes(sid)) tc.openStages.push(sid);
  } else {
    tc.openStages = tc.openStages.filter(s => s !== sid);
  }
  autoSave();
  renderDashboard();
}

function tcUM(sid, i, f, v) {
  gTC().stages[sid].milestones[i][f] = v;
  autoSave();
  renderDashboard();
}

function tcRM(sid, i) {
  gTC().stages[sid].milestones.splice(i, 1);
  autoSave();
  renderDashboard();
}

function tcAM(sid) {
  gTC().stages[sid].milestones.push({ id: mId(), name: '', desc: '', weight: 10 });
  autoSave();
  renderDashboard();
}

function changeWeek(d) {
  const n = state.currentWeek + d;
  if (n < 1 || n > state.totalWeeks) return;
  state.currentWeek = n;
  gTC();
  if (state.activeTab === 'dashboard') renderDashboard();
}

function addWeek() {
  state.totalWeeks++;
  state.currentWeek = state.totalWeeks;
  gTC();
  autoSave();
  renderDashboard();
  showToast('saved', '‚úì Week ' + state.totalWeeks);
}

// ===== GROUPS TAB =====
function renderGroupsTab() {
  let html = `
    <div class="map-header">
      <h1>üë• Student Groups</h1>
      <p>Browse all groups and their collaborative work.</p>
    </div>
    <div id="groupsList"></div>
  `;
  document.getElementById('mainContent').innerHTML = html;
  loadAndShowGroups();
}

async function loadAndShowGroups() {
  const groupsList = document.getElementById('groupsList');
  const groups = await fetchGroups();

  if (!groups || groups.length === 0) {
    groupsList.innerHTML = '<div class="teacher-card"><p style="color:var(--text-muted)">No groups found.</p></div>';
    return;
  }

  groupsList.innerHTML = groups.map(grp => `
    <div class="group-card" onclick="selectGroup('${esc(grp)}')">
      <h4>üìä ${esc(grp)}</h4>
      <p style="font-size:.8rem;color:var(--text-muted)">Click to view group work</p>
    </div>
  `).join('');
}

function selectGroup(groupName) {
  state.selectedGroup = groupName;
  showGroupDetail(groupName);
}

function showGroupDetail(groupName) {
  let html = `
    <button class="back-btn" onclick="backToGroups()">‚Üê Groups</button>
    <div class="map-header">
      <h1>${groupName}</h1>
      <p>View the group's collaborative work across all stages.</p>
    </div>
    <div id="groupDetailContent"></div>
  `;
  document.getElementById('mainContent').innerHTML = html;

  const tc = gTC();
  const content = document.getElementById('groupDetailContent');

  content.innerHTML = tc.openStages.map(sid => {
    const s = STAGES.find(x => x.id === sid);
    return `
      <div class="teacher-card">
        <h3>${s.icon} ${s.name}</h3>
        <div id="group-${sid}-blocks" style="font-size:.85rem;color:var(--text-muted)">Loading group work...</div>
      </div>
    `;
  }).join('');

  // Simulate group work display
  tc.openStages.forEach(sid => {
    const blockDiv = document.getElementById(`group-${sid}-blocks`);
    blockDiv.innerHTML = `
      <div class="read-only-block">
        <div style="font-weight:700;margin-bottom:6px">üìù Group Research Notes</div>
        <div class="block-content">We interviewed 3 users about their daily challenges with time management. Key findings: users struggle with context switching.</div>
      </div>
      <div class="read-only-block">
        <div style="font-weight:700;margin-bottom:6px">üì∏ Evidence Photos</div>
        <p style="font-size:.8rem;color:var(--text-muted)">2 photos uploaded</p>
      </div>
    `;
  });
}

function backToGroups() {
  state.selectedGroup = null;
  state.activeTab = 'groups';
  renderGroupsTab();
}

// ===== STUDENTS TAB =====
function renderStudentsTab() {
  let html = `
    <div class="map-header">
      <h1>üë§ Individual Students</h1>
      <p>Browse all students and their personal work.</p>
    </div>
    <div id="studentsList"></div>
  `;
  document.getElementById('mainContent').innerHTML = html;
  loadAndShowStudents();
}

async function loadAndShowStudents() {
  const studentsList = document.getElementById('studentsList');
  const students = await fetchStudents();

  if (!students || students.length === 0) {
    studentsList.innerHTML = '<div class="teacher-card"><p style="color:var(--text-muted)">No students found.</p></div>';
    return;
  }

  let html = `
    <div class="teacher-card">
      <table class="students-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>User ID</th>
            <th>Group</th>
            <th style="width:100px">Action</th>
          </tr>
        </thead>
        <tbody>
          ${students.map(student => `
            <tr>
              <td>${esc(student.name || 'Unknown')}</td>
              <td>${esc(student.userid || '‚Äî')}</td>
              <td>${esc(student.group || '‚Äî')}</td>
              <td>
                <button class="t-btn" style="padding:5px 12px;font-size:.75rem" onclick="selectStudent('${esc(student.userid || student.name)}', '${esc(student.name || 'Unknown')}')">View</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  studentsList.innerHTML = html;
}

function selectStudent(userId, name) {
  state.selectedStudent = { id: userId, name: name };
  showStudentDetail(userId, name);
}

function showStudentDetail(userId, name) {
  let html = `
    <button class="back-btn" onclick="backToStudents()">‚Üê Students</button>
    <div class="map-header">
      <h1>${esc(name)}</h1>
      <p style="font-size:.85rem">Personal work across all design thinking stages (Week ${state.currentWeek})</p>
    </div>
    <div id="studentDetailContent"></div>
  `;
  document.getElementById('mainContent').innerHTML = html;

  const tc = gTC();
  const content = document.getElementById('studentDetailContent');

  content.innerHTML = tc.openStages.map(sid => {
    const s = STAGES.find(x => x.id === sid);
    return `
      <div class="teacher-card">
        <h3>${s.icon} ${s.name}</h3>
        <div id="student-${sid}-work" style="font-size:.85rem;color:var(--text-muted)">Loading personal work...</div>
      </div>
    `;
  }).join('');

  // Simulate student personal work display
  tc.openStages.forEach(sid => {
    const workDiv = document.getElementById(`student-${sid}-work`);
    workDiv.innerHTML = `
      <div class="read-only-block">
        <div style="font-weight:700;margin-bottom:6px">üë§ Personal Notes</div>
        <div class="block-content">I found the user's main pain point is keeping track of multiple projects. They need a simple way to visualize priorities.</div>
      </div>
      <div class="read-only-block">
        <div style="font-weight:700;margin-bottom:6px">ü™û Reflection</div>
        <div class="block-content">This stage helped me understand that empathy is about truly listening. I need to ask better follow-up questions next time.</div>
      </div>
    `;
  });
}

function backToStudents() {
  state.selectedStudent = null;
  state.activeTab = 'students';
  renderStudentsTab();
}

// ===== TAB SWITCHING =====
function switchTab(tab) {
  state.activeTab = tab;
  state.selectedGroup = null;
  state.selectedStudent = null;

  if (tab === 'dashboard') {
    renderDashboard();
  } else if (tab === 'groups') {
    renderGroupsTab();
  } else if (tab === 'students') {
    renderStudentsTab();
  }
}

function renderMainTabs() {
  const mainContent = document.getElementById('mainContent');
  const tabNav = `
    <div style="margin-bottom:20px">
      <div class="tabs">
        <button class="tab-btn ${state.activeTab === 'dashboard' ? 'active' : ''}" onclick="switchTab('dashboard')">üìã Dashboard</button>
        <button class="tab-btn ${state.activeTab === 'groups' ? 'active' : ''}" onclick="switchTab('groups')">üë• Groups</button>
        <button class="tab-btn ${state.activeTab === 'students' ? 'active' : ''}" onclick="switchTab('students')">üë§ Students</button>
      </div>
    </div>
  `;

  mainContent.innerHTML = tabNav;

  if (state.activeTab === 'dashboard') {
    const container = mainContent;
    container.innerHTML = tabNav + container.innerHTML;
    renderDashboard();
  } else if (state.activeTab === 'groups') {
    renderGroupsTab();
  } else if (state.activeTab === 'students') {
    renderStudentsTab();
  }
}

// ===== AI COACH =====
const AIR = {
  empathize: ['Ask open-ended questions like "Tell me about a time when..."', 'Pay attention to what users DO, not just SAY.', 'Try an empathy map: Says, Thinks, Does, Feels.'],
  define: ['Problem statement: "[User] needs [need] because [insight]"', 'Try "How Might We" questions!'],
  ideate: ['QUANTITY over quality! 20 ideas in 5 minutes.', 'Crazy 8s: 8 boxes, 1 minute each.', 'SCAMPER: Substitute, Combine, Adapt, Modify, Put to use, Eliminate, Reverse.'],
  prototype: ['Prototype needs to be TESTABLE, not perfect.', 'Paper prototypes work great!'],
  test: ['Give minimal instructions and observe.', 'Note hesitations, confusion, and delight.'],
  fallback: ['What stage are you on?', 'Design thinking is iterative!', 'Think from the user perspective!']
};

function getAIR() {
  const tips = AIR.fallback;
  return tips[Math.floor(Math.random() * tips.length)];
}

function askAI(t) {
  document.getElementById('aiInput').value = t;
  sendAI();
}

function sendAI() {
  const inp = document.getElementById('aiInput');
  const m = inp.value.trim();
  if (!m) return;
  const msgs = document.getElementById('aiMessages');
  msgs.innerHTML += '<div class="ai-msg user">' + esc(m) + '</div>';
  inp.value = '';
  msgs.innerHTML += '<div class="ai-msg bot" id="typing"><div class="typing-dots"><span></span><span></span><span></span></div></div>';
  msgs.scrollTop = msgs.scrollHeight;
  setTimeout(() => {
    const el = document.getElementById('typing');
    if (el) {
      el.innerHTML = getAIR();
      el.id = '';
    }
    msgs.scrollTop = msgs.scrollHeight;
  }, 700 + Math.random() * 600);
  document.getElementById('aiPanel').classList.add('open');
}

// ===== INIT =====
document.getElementById('aiToggle').addEventListener('click', () => {
  document.getElementById('aiPanel').classList.toggle('open');
});

document.getElementById('aiClose').addEventListener('click', () => {
  document.getElementById('aiPanel').classList.remove('open');
});

document.getElementById('aiInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') sendAI();
});

// Sync indicator
setInterval(() => {
  const d = document.getElementById('syncDot');
  const l = document.getElementById('syncLabel');
  d.style.opacity = '0.4';
  l.textContent = 'Syncing...';
  setTimeout(() => {
    d.style.opacity = '1';
    l.textContent = 'Synced';
    saveState();
  }, 1200);
}, 30000);

// Start app
(async function init() {
  await authBootstrap();
  document.getElementById('navName').textContent = config.name;
  loadState();
  if (Object.keys(TD.weekConfigs).length === 0) {
    state.totalWeeks = 1;
    gTC();
  }
  renderMainTabs();
})();
</script>
</body>
</html>
