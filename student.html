<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lumos - Student Portal</title>
  <style>
    :root{
      --bg:#f0fdf4;
      --surface:#fff;
      --surface-2:#f7f8fc;
      --surface-3:#eef1f8;
      --border:#e0e4ef;
      --border-focus:#a5b4fc;
      --text:#1e293b;
      --text-muted:#64748b;
      --text-dim:#94a3b8;
      --shadow:0 2px 12px rgba(100,116,180,.08);
      --shadow-hover:0 6px 24px rgba(100,116,180,.14);
      --empathize:#ec4899;
      --define:#f97316;
      --ideate:#eab308;
      --prototype:#22c55e;
      --test:#3b82f6;
      --accent:#6366f1;
      --error:#ef4444;
      --success:#10b981;
      --teacher:#7c3aed;
      --student:#ec4899;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter','Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
    .top-nav{display:flex;align-items:center;justify-content:space-between;padding:1rem 2rem;background:var(--surface);border-bottom:1px solid var(--border);box-shadow:var(--shadow);position:sticky;top:0;z-index:100}
    .logo{display:flex;align-items:center;gap:.5rem;font-weight:700;font-size:1.25rem;color:var(--student)}
    .logo-icon{font-size:1.5rem}
    .nav-right{display:flex;align-items:center;gap:1.5rem}
    .sync-status{display:flex;align-items:center;gap:.5rem;font-size:.85rem;color:var(--text-muted)}
    .sync-dot{width:8px;height:8px;border-radius:50%;background:var(--success);animation:pulse .2s}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(16,185,129,.7)}100%{box-shadow:0 0 0 10px rgba(16,185,129,0)}}
    .group-badge{font-size:.85rem;font-weight:600;padding:.25rem .75rem;background:var(--surface-3);border:1px solid var(--border);border-radius:.375rem;color:var(--text)}
    .avatar{width:2.5rem;height:2.5rem;border-radius:50%;background:var(--student);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;transition:transform .2s}
    .avatar:hover{transform:scale(1.05)}
    .avatar-menu{position:absolute;top:100%;right:0;background:var(--surface);border:1px solid var(--border);border-radius:.5rem;box-shadow:var(--shadow-hover);min-width:200px;margin-top:.5rem;z-index:200}
    .avatar-menu-item{padding:.75rem 1rem;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:.25rem}
    .avatar-menu-item:last-child{border:none}
    .avatar-menu-item label{font-size:.75rem;font-weight:600;color:var(--text-muted);text-transform:uppercase}
    .avatar-menu-item input{padding:.375rem;border:1px solid var(--border);border-radius:.25rem;font-size:.9rem}
    .top-nav a{color:var(--student);text-decoration:none;font-weight:500;cursor:pointer;transition:color .2s}
    .top-nav a:hover{color:var(--define)}
    .container{display:flex;max-width:1400px;margin:0 auto;padding:2rem;gap:2rem;min-height:calc(100vh - 80px)}
    .map-view{flex:1}
    .detail-view{flex:1;display:none}
    .stage-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-bottom:2rem}
    .stage-card{background:var(--surface);border:2px solid var(--border);border-radius:.75rem;padding:1.5rem;cursor:pointer;transition:all .3s;position:relative}
    .stage-card.locked{opacity:.5;cursor:not-allowed;background:var(--surface-2)}
    .stage-card:not(.locked):hover{border-color:var(--border-focus);box-shadow:var(--shadow-hover);transform:translateY(-2px)}
    .stage-card-icon{font-size:2.5rem;margin-bottom:.5rem}
    .stage-card-name{font-weight:700;font-size:1.1rem;margin-bottom:.25rem}
    .stage-card-desc{font-size:.85rem;color:var(--text-muted);margin-bottom:1rem;line-height:1.4}
    .stage-card-lock{position:absolute;top:1rem;right:1rem;font-size:1.5rem}
    .progress-bar{height:6px;background:var(--surface-3);border-radius:3px;overflow:hidden;margin-bottom:.5rem}
    .progress-fill{height:100%;background:var(--accent);transition:width .3s}
    .progress-label{font-size:.75rem;color:var(--text-muted);display:flex;justify-content:space-between}
    .detail-header{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:2px solid var(--border)}
    .detail-back{background:var(--surface);border:1px solid var(--border);padding:.5rem 1rem;border-radius:.375rem;cursor:pointer;font-weight:500;transition:all .2s}
    .detail-back:hover{background:var(--surface-3);border-color:var(--border-focus)}
    .detail-title{display:flex;align-items:center;gap:.75rem}
    .detail-title-icon{font-size:2.5rem}
    .detail-title-text h1{font-size:2rem;margin-bottom:.25rem}
    .detail-title-text p{color:var(--text-muted);font-size:.9rem}
    .tabs{display:flex;gap:2rem;margin-bottom:2rem;border-bottom:2px solid var(--border)}
    .tab{padding:.75rem 0;cursor:pointer;font-weight:600;color:var(--text-muted);border-bottom:3px solid transparent;transition:all .2s;position:relative;bottom:-2px}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .announcement{background:var(--surface-3);border-left:4px solid var(--define);padding:1rem;border-radius:.5rem;margin-bottom:1.5rem}
    .announcement-label{font-size:.75rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;margin-bottom:.5rem}
    .group-members{display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:2rem;padding:1rem;background:var(--surface-2);border-radius:.5rem}
    .member{display:flex;align-items:center;gap:.5rem}
    .member-avatar{width:28px;height:28px;border-radius:50%;background:var(--student);color:white;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:600}
    .member-online{display:inline-flex;align-items:center;gap:.25rem;font-size:.85rem}
    .member-online-dot{width:6px;height:6px;border-radius:50%;background:var(--success);animation:pulse .2s}
    .milestones-panel{background:var(--surface-2);border:1px solid var(--border);border-radius:.5rem;padding:1.5rem;margin-bottom:1.5rem}
    .panel-title{font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
    .milestone-item{display:flex;justify-content:space-between;align-items:center;padding:.75rem;background:var(--surface);border-radius:.375rem;margin-bottom:.5rem;border-left:4px solid var(--accent)}
    .milestone-name{font-weight:600;font-size:.9rem}
    .milestone-weight{background:var(--accent);color:white;padding:.25rem .5rem;border-radius:.25rem;font-size:.75rem;font-weight:600}
    .ai-panel{background:var(--surface-2);border:1px solid var(--border);border-radius:.5rem;padding:1.5rem;margin-bottom:1.5rem}
    .ai-button{background:var(--accent);color:white;padding:.75rem 1.5rem;border:none;border-radius:.375rem;font-weight:600;cursor:pointer;transition:all .2s;width:100%}
    .ai-button:hover{background:#5558e3;transform:translateY(-1px);box-shadow:var(--shadow-hover)}
    .canvas{background:var(--surface);border:1px solid var(--border);border-radius:.5rem;padding:1.5rem;min-height:400px;margin-bottom:1.5rem;position:relative}
    .canvas-grid{display:grid;gap:1.5rem;margin-bottom:1.5rem}
    .block{background:var(--surface-2);border:1px solid var(--border);border-radius:.5rem;position:relative;touch-action:none;cursor:move;transition:all .2s}
    .block:hover{border-color:var(--border-focus);box-shadow:var(--shadow-hover)}
    .block.dragging{opacity:.5;box-shadow:var(--shadow-hover)}
    .block-header{display:flex;align-items:center;padding:1rem;background:var(--surface-3);border-bottom:1px solid var(--border);border-radius:.375rem .375rem 0 0;gap:.5rem}
    .block-handle{cursor:grab;color:var(--text-dim);font-weight:700}
    .block-handle:active{cursor:grabbing}
    .block-title{flex:1;font-weight:600;color:var(--text);background:transparent;border:none;padding:0;font-size:.95rem;min-width:150px}
    .block-title:focus{outline:2px solid var(--border-focus);border-radius:.25rem}
    .block-badges{display:flex;gap:.5rem;margin-left:auto;align-items:center}
    .block-badge{font-size:.7rem;font-weight:700;padding:.25rem .5rem;border-radius:.25rem;background:var(--surface);color:var(--text-muted);text-transform:uppercase}
    .block-author{background:var(--student);color:white}
    .block-type{background:var(--accent);color:white}
    .block-actions{display:flex;gap:.25rem;margin-left:.5rem}
    .block-action{background:transparent;border:none;cursor:pointer;color:var(--text-dim);font-size:.9rem;transition:color .2s;padding:.25rem}
    .block-action:hover{color:var(--text)}
    .block-body{padding:1rem}
    .block-textarea{width:100%;min-height:80px;padding:.75rem;border:1px solid var(--border);border-radius:.375rem;font-family:'Inter',sans-serif;font-size:.9rem;color:var(--text);background:var(--surface);resize:vertical}
    .block-textarea:focus{outline:2px solid var(--border-focus);border-color:var(--border-focus)}
    .photos-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:1rem;margin-bottom:1rem}
    .photo-item{position:relative;border-radius:.375rem;overflow:hidden;aspect-ratio:1;cursor:pointer}
    .photo-item img{width:100%;height:100%;object-fit:cover}
    .photo-remove{position:absolute;top:.25rem;right:.25rem;background:var(--error);color:white;border:none;cursor:pointer;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;opacity:0;transition:opacity .2s}
    .photo-item:hover .photo-remove{opacity:1}
    .upload-zone{border:2px dashed var(--border);border-radius:.375rem;padding:1.5rem;text-align:center;cursor:pointer;transition:all .2s;background:var(--surface)}
    .upload-zone:hover{border-color:var(--border-focus);background:var(--surface-3)}
    .upload-zone-text{font-size:.85rem;color:var(--text-muted)}
    .checklist-items{display:flex;flex-direction:column;gap:.5rem;margin-bottom:1rem}
    .checklist-item{display:flex;align-items:center;gap:.75rem}
    .checklist-item input[type="checkbox"]{width:18px;height:18px;cursor:pointer;accent-color:var(--accent)}
    .checklist-item label{flex:1;cursor:pointer;color:var(--text)}
    .checklist-item.done label{text-decoration:line-through;color:var(--text-muted)}
    .checklist-add{background:var(--surface);border:1px solid var(--border);padding:.5rem .75rem;border-radius:.25rem;font-size:.85rem;color:var(--text-muted);width:100%;cursor:pointer;transition:all .2s}
    .checklist-add:hover{border-color:var(--border-focus);background:var(--surface-2)}
    .block-footer{display:flex;align-items:center;gap:1rem;padding:1rem;border-top:1px solid var(--border);background:var(--surface-2);border-radius:0 0 .375rem .375rem}
    .block-like{display:flex;align-items:center;gap:.5rem;cursor:pointer;color:var(--text-muted);font-size:.85rem;transition:all .2s}
    .block-like:hover{color:var(--student)}
    .block-like.liked{color:var(--student)}
    .block-like-count{min-width:20px}
    .block-comment-toggle{cursor:pointer;color:var(--text-muted);font-size:.85rem;transition:color .2s;display:flex;align-items:center;gap:.5rem;margin-left:auto}
    .block-comment-toggle:hover{color:var(--text)}
    .comments-section{max-height:0;overflow:hidden;transition:max-height .3s;background:var(--surface);border-top:1px solid var(--border)}
    .comments-section.open{max-height:500px}
    .comments-list{padding:1rem;display:flex;flex-direction:column;gap:.75rem;max-height:200px;overflow-y:auto}
    .comment{display:flex;gap:.75rem}
    .comment-avatar{width:28px;height:28px;border-radius:50%;background:var(--accent);color:white;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:600;flex-shrink:0}
    .comment-content{flex:1;min-width:0}
    .comment-author{font-weight:600;font-size:.85rem;color:var(--text)}
    .comment-text{font-size:.85rem;color:var(--text-muted);margin-top:.25rem}
    .comment-input-wrapper{padding:1rem;border-top:1px solid var(--border);display:flex;gap:.5rem}
    .comment-input-wrapper input{flex:1;padding:.5rem;border:1px solid var(--border);border-radius:.25rem;font-size:.85rem}
    .comment-input-wrapper button{background:var(--accent);color:white;border:none;cursor:pointer;padding:.5rem .75rem;border-radius:.25rem;font-weight:600;transition:all .2s}
    .comment-input-wrapper button:hover{background:#5558e3}
    .add-block-buttons{display:flex;flex-wrap:wrap;gap:.75rem;margin-bottom:1.5rem}
    .add-block-btn{background:var(--surface);border:1px solid var(--border);padding:.75rem 1rem;border-radius:.375rem;cursor:pointer;font-weight:600;color:var(--text-muted);transition:all .2s;display:flex;align-items:center;gap:.5rem}
    .add-block-btn:hover{border-color:var(--border-focus);background:var(--surface-3);color:var(--text)}
    .reflection-section{background:var(--surface-2);border:1px solid var(--border);border-radius:.5rem;padding:1.5rem;margin-top:2rem}
    .reflection-title{font-weight:700;margin-bottom:1rem}
    .reflection-textarea{width:100%;min-height:120px;padding:1rem;border:1px solid var(--border);border-radius:.375rem;font-family:'Inter',sans-serif;font-size:.9rem;color:var(--text);background:var(--surface)}
    .reflection-textarea:focus{outline:2px solid var(--border-focus)}
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:300}
    .modal-overlay.open{display:flex;align-items:center;justify-content:center}
    .modal{background:var(--surface);border-radius:.75rem;padding:2rem;max-width:500px;width:90%;box-shadow:var(--shadow-hover);max-height:80vh;overflow-y:auto}
    .modal-close{float:right;cursor:pointer;font-size:1.5rem;color:var(--text-muted);background:none;border:none;transition:color .2s}
    .modal-close:hover{color:var(--text)}
    .modal h2{margin-bottom:1.5rem;margin-top:0}
    .modal-input{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:.375rem;margin-bottom:1rem;font-family:'Inter',sans-serif;font-size:.9rem}
    .modal-input:focus{outline:2px solid var(--border-focus)}
    .modal-buttons{display:flex;gap:1rem;margin-top:1.5rem}
    .modal-btn{flex:1;padding:.75rem;border:none;border-radius:.375rem;font-weight:600;cursor:pointer;transition:all .2s}
    .modal-btn-primary{background:var(--accent);color:white}
    .modal-btn-primary:hover{background:#5558e3}
    .modal-btn-secondary{background:var(--surface-3);color:var(--text)}
    .modal-btn-secondary:hover{background:var(--border)}
    .toast{position:fixed;bottom:2rem;right:2rem;background:var(--surface);border:1px solid var(--border);border-radius:.5rem;padding:1rem 1.5rem;box-shadow:var(--shadow-hover);z-index:400;animation:slideIn .3s}
    @keyframes slideIn{from{transform:translateX(400px)}to{transform:translateX(0)}}
    .ai-coach-btn{position:fixed;bottom:2rem;right:2rem;width:60px;height:60px;border-radius:50%;background:var(--accent);color:white;border:none;cursor:pointer;font-size:1.75rem;box-shadow:var(--shadow-hover);transition:all .3s;z-index:200}
    .ai-coach-btn:hover{transform:scale(1.1);box-shadow:0 8px 24px rgba(99,102,241,.4)}
    .ai-coach-panel{position:fixed;right:-400px;bottom:0;width:400px;height:100vh;background:var(--surface);border-left:2px solid var(--border);box-shadow:0 0 30px rgba(0,0,0,.2);z-index:250;transition:right .3s;display:flex;flex-direction:column;max-height:100vh}
    .ai-coach-panel.open{right:0}
    .ai-coach-header{padding:1.5rem;border-bottom:2px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .ai-coach-close{background:none;border:none;cursor:pointer;font-size:1.5rem;color:var(--text-muted)}
    .ai-coach-messages{flex:1;overflow-y:auto;padding:1.5rem;display:flex;flex-direction:column;gap:1rem}
    .ai-message{background:var(--surface-3);padding:1rem;border-radius:.5rem;border-left:4px solid var(--accent);font-size:.9rem;line-height:1.5}
    .user-message{background:var(--accent);color:white;padding:1rem;border-radius:.5rem;border-left:none;font-size:.9rem;line-height:1.5;margin-left:auto;max-width:80%}
    .ai-coach-input{padding:1.5rem;border-top:2px solid var(--border);display:flex;gap:.5rem}
    .ai-coach-input input{flex:1;padding:.75rem;border:1px solid var(--border);border-radius:.375rem;font-size:.85rem}
    .ai-coach-input button{background:var(--accent);color:white;border:none;cursor:pointer;padding:.75rem 1rem;border-radius:.375rem;font-weight:600;transition:all .2s}
    .ai-coach-input button:hover{background:#5558e3}
    .teacherView{display:none!important}
    .timestamp{font-size:.75rem;color:var(--text-dim);margin-top:.25rem}
    @media(max-width:768px){
      .container{flex-direction:column;padding:1rem}
      .stage-grid{grid-template-columns:1fr}
      .ai-coach-panel{width:100%;right:-100%}
      .top-nav{padding:1rem;flex-wrap:wrap}
      .nav-right{gap:1rem}
    }
  </style>
</head>
<body>
  <nav class="top-nav">
    <div class="logo">
      <div class="logo-icon">üí°</div>
      <span class="logo-text">Student Portal</span>
    </div>
    <div class="nav-right">
      <div class="sync-status"><div class="sync-dot" id="syncDot"></div><span id="syncLabel">Synced</span></div>
      <span class="group-badge" id="groupBadge">Group 1</span>
      <span style="font-weight:700;font-size:.85rem" id="navName">Student</span>
      <div style="position:relative">
        <div class="avatar" id="avatarBtn" onclick="toggleConfig()">
          <span id="avatarInitials">ST</span>
        </div>
        <div id="avatarMenu" class="avatar-menu" style="display:none">
          <div class="avatar-menu-item">
            <label>Your Name</label>
            <input type="text" id="cfName" placeholder="Name">
          </div>
          <div class="avatar-menu-item">
            <label>Group</label>
            <input type="text" id="cfGroup" placeholder="Group" disabled>
          </div>
          <div class="avatar-menu-item">
            <label>Group Members</label>
            <input type="text" id="cfMembers" placeholder="Members" disabled>
          </div>
        </div>
      </div>
      <a href="#" onclick="logout(); return false;">Log out</a>
    </div>
  </nav>

  <div class="container">
    <div class="map-view" id="mapView">
      <div style="margin-bottom:2rem;display:flex;justify-content:space-between;align-items:center">
        <h2 style="font-size:1.5rem">Week <span id="weekNum">1</span> of <span id="totalWeeks">1</span></h2>
        <div style="display:flex;gap:.75rem">
          <button class="detail-back" onclick="changeWeek(-1)" id="prevWeekBtn">‚Üê Previous</button>
          <button class="detail-back" onclick="changeWeek(1)" id="nextWeekBtn">Next ‚Üí</button>
        </div>
      </div>
      <div class="stage-grid" id="stageGrid"></div>
      <div style="margin-top:2rem;padding:1.5rem;background:var(--surface);border-radius:.5rem;border-left:4px solid var(--accent)">
        <div style="font-weight:600;margin-bottom:.5rem">Overall Progress</div>
        <div class="progress-bar">
          <div class="progress-fill" id="overallProgress" style="width:0%"></div>
        </div>
        <div class="progress-label">
          <span>All Stages</span>
          <span id="overallPercent">0%</span>
        </div>
      </div>
    </div>

    <div class="detail-view" id="detailView">
      <div class="detail-header">
        <button class="detail-back" onclick="closeDetail()">‚Üê Back</button>
        <div class="detail-title">
          <div class="detail-title-icon" id="stageIcon">‚ù§Ô∏è</div>
          <div class="detail-title-text">
            <h1 id="stageName">Empathize</h1>
            <p id="stageWeek">Week 1</p>
          </div>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="switchTab('group')">ü§ù Group</div>
        <div class="tab" onclick="switchTab('personal')">üë§ Personal</div>
      </div>

      <div id="groupTab" class="tab-content active">
        <div id="announcementSection"></div>
        <div id="groupMembersSection"></div>
        <div id="milestonesPanel"></div>
        <div id="aiPanel"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
          <h3 style="font-weight:700">Group Canvas</h3>
          <div class="add-block-buttons" id="groupAddBlocksGroup"></div>
        </div>
        <div class="canvas">
          <div class="canvas-grid" id="groupCanvas"></div>
        </div>
        <div class="reflection-section">
          <div class="reflection-title">Group Reflection</div>
          <textarea class="reflection-textarea" id="groupReflection" placeholder="Share your group's insights..."></textarea>
          <div style="margin-top:.5rem;font-size:.8rem;color:var(--text-dim)" id="groupRefTime"></div>
        </div>
      </div>

      <div id="personalTab" class="tab-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
          <h3 style="font-weight:700">Your Personal Canvas</h3>
          <div class="add-block-buttons" id="personalAddBlocksGroup"></div>
        </div>
        <div class="canvas">
          <div class="canvas-grid" id="personalCanvas"></div>
        </div>
        <div class="reflection-section">
          <div class="reflection-title">Your Personal Reflection</div>
          <textarea class="reflection-textarea" id="personalReflection" placeholder="Your personal insights and observations..."></textarea>
          <div style="margin-top:.5rem;font-size:.8rem;color:var(--text-dim)" id="personalRefTime"></div>
        </div>
      </div>
    </div>
  </div>

  <button class="ai-coach-btn" onclick="toggleAICoach()">ü§ñ</button>
  <div class="ai-coach-panel" id="aiCoachPanel">
    <div class="ai-coach-header">
      <div style="font-weight:700">AI Coach</div>
      <button class="ai-coach-close" onclick="toggleAICoach()">‚úï</button>
    </div>
    <div class="ai-coach-messages" id="aiMessages"></div>
    <div class="ai-coach-input">
      <input type="text" id="aiInput" placeholder="Ask me anything..." onkeypress="if(event.key==='Enter') sendAIMessage()">
      <button onclick="sendAIMessage()">Send</button>
    </div>
  </div>

  <div id="modalOverlay" class="modal-overlay">
    <div class="modal" id="modal">
      <button class="modal-close" onclick="closeModal()">‚úï</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <div id="configModal" style="display:none;position:absolute;top:100%;right:0;background:var(--surface);border:1px solid var(--border);border-radius:.5rem;box-shadow:var(--shadow-hover);min-width:200px;margin-top:.5rem;z-index:200"></div>

  <script>
    const STAGES = [
      {id:'empathize', name:'Empathize', icon:'‚ù§Ô∏è', color:'#ec4899', bg:'#fce7f3', desc:'Research user needs through observation and interviews.'},
      {id:'define', name:'Define', icon:'üéØ', color:'#f97316', bg:'#fff7ed', desc:'Synthesize findings into a human-centered problem statement.'},
      {id:'ideate', name:'Ideate', icon:'üí°', color:'#eab308', bg:'#fefce8', desc:'Brainstorm creative ideas ‚Äî go wild!'},
      {id:'prototype', name:'Prototype', icon:'üîß', color:'#22c55e', bg:'#f0fdf4', desc:'Build a rough, testable version of your solution.'},
      {id:'test', name:'Test', icon:'üß™', color:'#3b82f6', bg:'#eff6ff', desc:'Get real feedback. Listen, observe, refine.'}
    ];

    const AIR = {
      empathize:{suggestions:['How can I better understand my user?','What patterns am I seeing?','What questions should I ask next?']},
      define:{suggestions:['What is the core problem?','Who is most affected?','What needs are most critical?']},
      ideate:{suggestions:['How might we approach this differently?','What are unconventional solutions?','Can we combine ideas?']},
      prototype:{suggestions:['What is the minimum viable version?','What should I test first?','What materials do I need?']},
      test:{suggestions:['What feedback did I receive?','What surprised me?','What should I iterate on?']}
    };

    let config = {name:'Student', group:'Group 1', members:['Student']};
    let state = {currentWeek:1, totalWeeks:1, currentStage:null, currentTab:'group', role:'student', weeks:{}};
    let TD = {announcements:{}, weekConfigs:{}};

    async function authBootstrap() {
      try {
        const r = await fetch('/api/auth/me', {credentials:'same-origin'});
        if (!r.ok) {window.location.href='/login.html'; return;}
        const u = await r.json();
        if (u.role !== 'student') {
          window.location.href = u.role === 'admin' ? '/admin.html' : '/teacher.html';
          return;
        }
        config.name = u.name || config.name;
        config.group = u.group || config.group;
        if (Array.isArray(u.members) && u.members.length) config.members = u.members;
        localStorage.setItem('dt-config', JSON.stringify(config));
        state.role = 'student';
        loadState();
        updateNav();
        renderStudentMap();
      } catch(e) {
        console.error('Auth error:', e);
        window.location.href='/login.html';
      }
    }

    function logout() {
      fetch('/api/auth/logout', {method:'POST', credentials:'same-origin'}).then(() => {
        window.location.href='/login.html';
      });
    }

    function updateNav() {
      document.getElementById('navName').textContent = config.name;
      document.getElementById('groupBadge').textContent = config.group;
      const initials = config.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
      document.getElementById('avatarInitials').textContent = initials;
      document.getElementById('cfName').value = config.name;
      document.getElementById('cfGroup').value = config.group;
      document.getElementById('cfMembers').value = (config.members || []).join(', ');
    }

    function toggleConfig() {
      const menu = document.getElementById('avatarMenu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    document.addEventListener('click', (e)=>{
      if (!e.target.closest('#avatarBtn') && !e.target.closest('#avatarMenu')) {
        document.getElementById('avatarMenu').style.display = 'none';
      }
    });

    document.getElementById('cfName').addEventListener('change', (e)=>{
      config.name = e.target.value;
      localStorage.setItem('dt-config', JSON.stringify(config));
      updateNav();
      autoSave();
    });

    function loadState() {
      try {
        const saved = localStorage.getItem('dt-v4');
        if (saved) state.weeks = JSON.parse(saved);
        const savedTD = localStorage.getItem('dt-v4t');
        if (savedTD) TD = JSON.parse(savedTD);
      } catch(e) {console.error('Load error:', e);}
      initializeWeeks();
    }

    function initializeWeeks() {
      if (!state.weeks[state.currentWeek]) {
        state.weeks[state.currentWeek] = {};
        STAGES.forEach(s=>{
          state.weeks[state.currentWeek][s.id] = {
            open:true, blocks:[], reflection:'', personal:{}
          };
          state.weeks[state.currentWeek][s.id].personal[config.name] = {blocks:[], reflection:''};
        });
      }
      updateWeekDisplay();
    }

    function updateWeekDisplay() {
      document.getElementById('weekNum').textContent = state.currentWeek;
      document.getElementById('totalWeeks').textContent = state.totalWeeks;
      document.getElementById('prevWeekBtn').disabled = state.currentWeek <= 1;
      document.getElementById('nextWeekBtn').disabled = state.currentWeek >= state.totalWeeks;
    }

    function changeWeek(delta) {
      const newWeek = state.currentWeek + delta;
      if (newWeek >= 1 && newWeek <= state.totalWeeks) {
        state.currentWeek = newWeek;
        initializeWeeks();
        if (state.currentStage) closeDetail();
        renderStudentMap();
      }
    }

    function renderStudentMap() {
      const grid = document.getElementById('stageGrid');
      grid.innerHTML = '';
      let totalProgress = 0;
      STAGES.forEach((stage, idx)=>{
        const wk = state.weeks[state.currentWeek];
        const stageData = wk[stage.id] || {};
        const isOpen = stageData.open !== false;
        const blockCount = (stageData.blocks || []).length;
        const progress = blockCount > 0 ? Math.min(100, blockCount * 25) : 0;
        totalProgress += progress;

        const card = document.createElement('div');
        card.className = `stage-card${!isOpen ? ' locked' : ''}`;
        card.onclick = () => {if(isOpen) openDetail(stage.id);};
        card.innerHTML = `
          <div style="position:relative">
            ${!isOpen ? '<div class="stage-card-lock">üîí</div>' : ''}
            <div class="stage-card-icon">${stage.icon}</div>
            <div class="stage-card-name">${stage.name}</div>
            <div class="stage-card-desc">${stage.desc}</div>
            <div style="margin-bottom:1rem"></div>
            <div class="progress-label" style="margin-bottom:.25rem">Group Progress</div>
            <div class="progress-bar" style="margin-bottom:1rem">
              <div class="progress-fill" style="width:${progress}%;background:${stage.color}"></div>
            </div>
            <div class="progress-label" style="margin-bottom:.5rem">AI Score</div>
            <div class="progress-bar">
              <div class="progress-fill" style="width:0%;background:${stage.color}"></div>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });
      const avg = Math.round(totalProgress / 5);
      document.getElementById('overallProgress').style.width = avg + '%';
      document.getElementById('overallPercent').textContent = avg + '%';
    }

    function openDetail(stageId) {
      state.currentStage = stageId;
      const stage = STAGES.find(s=>s.id===stageId);
      document.getElementById('stageIcon').textContent = stage.icon;
      document.getElementById('stageName').textContent = stage.name;
      document.getElementById('stageWeek').textContent = `Week ${state.currentWeek}`;
      document.getElementById('mapView').style.display = 'none';
      document.getElementById('detailView').style.display = 'block';
      switchTab('group');
    }

    function closeDetail() {
      state.currentStage = null;
      document.getElementById('detailView').style.display = 'none';
      document.getElementById('mapView').style.display = 'block';
    }

    function switchTab(tab) {
      state.currentTab = tab;
      document.querySelectorAll('.tab').forEach((t, i)=>{
        t.classList.toggle('active', (i===0 && tab==='group') || (i===1 && tab==='personal'));
      });
      document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
      document.getElementById((tab==='group'?'group':'personal')+'Tab').classList.add('active');
      if (tab === 'group') renderGroupTab();
      else renderPersonalTab();
    }

    function renderGroupTab() {
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];

      const ann = TD.announcements && TD.announcements[state.currentStage];
      const annSection = document.getElementById('announcementSection');
      annSection.innerHTML = ann ? `<div class="announcement"><div class="announcement-label">Teacher Announcement</div><div>${ann}</div></div>` : '';

      const membersSection = document.getElementById('groupMembersSection');
      const membersList = (config.members || []).map(m=>`
        <div class="member">
          <div class="member-avatar">${m.split(' ').map(x=>x[0]).join('').toUpperCase()}</div>
          <div class="member-online"><span>${m}</span><span class="member-online-dot"></span></div>
        </div>
      `).join('');
      membersSection.innerHTML = membersSection.innerHTML.length > 0 ? '' : `<div class="group-members">${membersList}</div>`;

      const milestonesPanel = document.getElementById('milestonesPanel');
      const milestones = [
        {name:'Empathy Map', weight:'15%'},
        {name:'Problem Statement', weight:'20%'},
        {name:'Brainstorm List', weight:'15%'},
        {name:'Prototype Sketch', weight:'25%'},
        {name:'Test Report', weight:'25%'}
      ];
      const milestonesHTML = milestones.map(m=>`
        <div class="milestone-item">
          <div class="milestone-name">${m.name}</div>
          <div class="milestone-weight">${m.weight}</div>
        </div>
      `).join('');
      milestonesPanel.innerHTML = `
        <div class="milestones-panel">
          <div class="panel-title">üìä Milestones & Weightage</div>
          ${milestonesHTML}
        </div>
      `;

      const aiPanel = document.getElementById('aiPanel');
      aiPanel.innerHTML = `
        <div class="ai-panel">
          <button class="ai-button" onclick="runAI()">üöÄ Run AI Assessment</button>
        </div>
      `;

      const addBlocksGroup = document.getElementById('groupAddBlocksGroup');
      addBlocksGroup.innerHTML = `
        <button class="add-block-btn" onclick="addBlock('notes')">üìù Note</button>
        <button class="add-block-btn" onclick="addBlock('photos')">üì∏ Photos</button>
        <button class="add-block-btn" onclick="addBlock('checklist')">‚úì Checklist</button>
        <button class="add-block-btn" onclick="addBlock('freeform')">‚úíÔ∏è Freeform</button>
      `;

      const canvas = document.getElementById('groupCanvas');
      canvas.innerHTML = (stageData.blocks || []).map((b, i)=>rB(b, i, 'group')).join('');
      initDD();
      initRz();

      const refText = document.getElementById('groupReflection');
      refText.value = stageData.reflection || '';
      refText.onchange = ()=>uRef('group');
      const refTime = document.getElementById('groupRefTime');
      refTime.textContent = stageData.reflectionTime ? `Last updated: ${new Date(stageData.reflectionTime).toLocaleString()}` : '';
    }

    function renderPersonalTab() {
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];
      const personalData = stageData.personal[config.name] || {blocks:[], reflection:''};

      const addBlocksGroup = document.getElementById('personalAddBlocksGroup');
      addBlocksGroup.innerHTML = `
        <button class="add-block-btn" onclick="addBlock('notes', 'personal')">üìù Note</button>
        <button class="add-block-btn" onclick="addBlock('photos', 'personal')">üì∏ Photos</button>
        <button class="add-block-btn" onclick="addBlock('checklist', 'personal')">‚úì Checklist</button>
        <button class="add-block-btn" onclick="addBlock('freeform', 'personal')">‚úíÔ∏è Freeform</button>
      `;

      const canvas = document.getElementById('personalCanvas');
      canvas.innerHTML = (personalData.blocks || []).map((b, i)=>rB(b, i, 'personal')).join('');
      initDD();
      initRz();

      const refText = document.getElementById('personalReflection');
      refText.value = personalData.reflection || '';
      refText.onchange = ()=>uRef('personal');
      const refTime = document.getElementById('personalRefTime');
      refTime.textContent = personalData.reflectionTime ? `Last updated: ${new Date(personalData.reflectionTime).toLocaleString()}` : '';
    }

    function addBlock(type, context='group') {
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];
      const blocks = context === 'group' ? stageData.blocks : stageData.personal[config.name].blocks;
      const newBlock = {
        id:mId(), type, title:`New ${type}`, author:config.name, content:'', items:[], comments:[], likes:0, photos:[]
      };
      blocks.push(newBlock);
      autoSave();
      switchTab(context);
    }

    function rmB(blockId, context='group') {
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];
      const blocks = context === 'group' ? stageData.blocks : stageData.personal[config.name].blocks;
      const idx = blocks.findIndex(b=>b.id===blockId);
      if (idx >= 0) blocks.splice(idx, 1);
      autoSave();
      switchTab(context);
    }

    function rB(block, idx, context='group') {
      const commentsOpen = block.commentsOpen ? 'open' : '';
      const commentCount = (block.comments || []).length;
      const liked = (block.likedBy || []).includes(config.name);
      return `
        <div class="block" data-block-id="${block.id}" data-context="${context}">
          <div class="block-header">
            <div class="block-handle">‚ãÆ‚ãÆ</div>
            <input type="text" class="block-title" value="${block.title}" onchange="uBT(this.value, '${block.id}', '${context}')">
            <div class="block-badges">
              <div class="block-badge block-author">${block.author}</div>
              <div class="block-badge block-type">${block.type}</div>
            </div>
            <div class="block-actions">
              ${idx > 0 ? `<button class="block-action" onclick="mvB('${block.id}', -1, '${context}')">‚Üë</button>` : ''}
              ${idx < (context==='group' ? state.weeks[state.currentWeek][state.currentStage].blocks.length-1 : state.weeks[state.currentWeek][state.currentStage].personal[config.name].blocks.length-1) ? `<button class="block-action" onclick="mvB('${block.id}', 1, '${context}')">‚Üì</button>` : ''}
              <button class="block-action" onclick="rmB('${block.id}', '${context}')">‚úï</button>
            </div>
          </div>
          <div class="block-body">
            ${block.type === 'notes' ? `<textarea class="block-textarea" onchange="uBD(this.value, '${block.id}', '${context}')">${block.content || ''}</textarea>` : ''}
            ${block.type === 'freeform' ? `<textarea class="block-textarea" style="min-height:150px;" onchange="uBD(this.value, '${block.id}', '${context}')">${block.content || ''}</textarea>` : ''}
            ${block.type === 'photos' ? `
              <div class="photos-grid">
                ${(block.photos || []).map((p, pi)=>`
                  <div class="photo-item">
                    <img src="${p.data}" alt="">
                    <button class="photo-remove" onclick="rmPh('${block.id}', ${pi}, '${context}')">‚úï</button>
                  </div>
                `).join('')}
              </div>
              <div class="upload-zone" onclick="document.getElementById('photoInput${block.id}').click()">
                <div class="upload-zone-text">üì∏ Click to upload photos</div>
              </div>
              <input type="file" id="photoInput${block.id}" accept="image/*" style="display:none" multiple onchange="upPh(event, '${block.id}', '${context}')">
            ` : ''}
            ${block.type === 'checklist' ? `
              <div class="checklist-items">
                ${(block.items || []).map((item, ii)=>`
                  <div class="checklist-item${item.done ? ' done' : ''}">
                    <input type="checkbox" ${item.done ? 'checked' : ''} onchange="tCI('${block.id}', ${ii}, '${context}')">
                    <label>${item.text}</label>
                  </div>
                `).join('')}
              </div>
              <button class="checklist-add" onclick="aCI('${block.id}', '${context}')">+ Add item</button>
            ` : ''}
          </div>
          <div class="block-footer">
            <div class="block-like${liked ? ' liked' : ''}" onclick="tLk('${block.id}', '${context}')">
              <span>${liked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
              <span class="block-like-count">${block.likes || 0}</span>
            </div>
            <div class="block-comment-toggle" onclick="tCm('${block.id}', '${context}')">
              üí¨ ${commentCount}
            </div>
          </div>
          <div class="comments-section${commentsOpen ? ' open' : ''}" id="comments${block.id}">
            <div class="comments-list">
              ${(block.comments || []).map(c=>`
                <div class="comment">
                  <div class="comment-avatar">${c.author.split(' ').map(x=>x[0]).join('').toUpperCase()}</div>
                  <div class="comment-content">
                    <div class="comment-author">${c.author}</div>
                    <div class="comment-text">${c.text}</div>
                  </div>
                </div>
              `).join('')}
            </div>
            <div class="comment-input-wrapper">
              <input type="text" placeholder="Add comment..." id="cmtInput${block.id}">
              <button onclick="aCm('${block.id}', document.getElementById('cmtInput${block.id}').value, '${context}')">Send</button>
            </div>
          </div>
          <div class="timestamp">${block.created ? new Date(block.created).toLocaleString() : 'Just now'}</div>
        </div>
      `;
    }

    function uBT(val, blockId, context) {
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];
      const blocks = context === 'group' ? stageData.blocks : stageData.personal[config.name].blocks;
      const block = blocks.find(b=>b.id===blockId);
      if (block) block.title = val;
      autoSave();
    }

    function uBD(val, blockId, context) {
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];
      const blocks = context === 'group' ? stageData.blocks : stageData.personal[config.name].blocks;
      const block = blocks.find(b=>b.id===blockId);
      if (block) block.content = val;
      autoSave();
    }

    function upPh(event, blockId, context) {
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];
      const blocks = context === 'group' ? stageData.blocks : stageData.personal[config.name].blocks;
      const block = blocks.find(b=>b.id===blockId);
      if (!block.photos) block.photos = [];
      Array.from(event.target.files).forEach(file=>{
        const reader = new FileReader();
        reader.onload = (e)=>{
          block.photos.push({data:e.target.result});
          autoSave();
          switchTab(context);
        };
        reader.readAsDataURL(file);
      });
    }

    function rmPh(blockId, photoIdx, context) {
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];
      const blocks = context === 'group' ? stageData.blocks : stageData.personal[config.name].blocks;
      const block = blocks.find(b=>b.id===blockId);
      if (block.photos) block.photos.splice(photoIdx, 1);
      autoSave();
      switchTab(context);
    }

    function tCI(blockId, itemIdx, context) {
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];
      const blocks = context === 'group' ? stageData.blocks : stageData.personal[config.name].blocks;
      const block = blocks.find(b=>b.id===blockId);
      if (block.items[itemIdx]) block.items[itemIdx].done = !block.items[itemIdx].done;
      autoSave();
      switchTab(context);
    }

    function aCI(blockId, context) {
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];
      const blocks = context === 'group' ? stageData.blocks : stageData.personal[config.name].blocks;
      const block = blocks.find(b=>b.id===blockId);
      if (!block.items) block.items = [];
      const text = prompt('Add checklist item:');
      if (text) {
        block.items.push({text, done:false});
        autoSave();
        switchTab(context);
      }
    }

    function tLk(blockId, context) {
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];
      const blocks = context === 'group' ? stageData.blocks : stageData.personal[config.name].blocks;
      const block = blocks.find(b=>b.id===blockId);
      if (!block.likedBy) block.likedBy = [];
      const idx = block.likedBy.indexOf(config.name);
      if (idx >= 0) {
        block.likedBy.splice(idx, 1);
        block.likes--;
      } else {
        block.likedBy.push(config.name);
        block.likes = (block.likes || 0) + 1;
      }
      autoSave();
      switchTab(context);
    }

    function tCm(blockId, context) {
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];
      const blocks = context === 'group' ? stageData.blocks : stageData.personal[config.name].blocks;
      const block = blocks.find(b=>b.id===blockId);
      block.commentsOpen = !block.commentsOpen;
      autoSave();
      switchTab(context);
    }

    function aCm(blockId, text, context) {
      if (!text.trim()) return;
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];
      const blocks = context === 'group' ? stageData.blocks : stageData.personal[config.name].blocks;
      const block = blocks.find(b=>b.id===blockId);
      if (!block.comments) block.comments = [];
      block.comments.push({author:config.name, text, timestamp:Date.now()});
      document.getElementById('cmtInput'+blockId).value = '';
      autoSave();
      switchTab(context);
    }

    function mvB(blockId, delta, context) {
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];
      const blocks = context === 'group' ? stageData.blocks : stageData.personal[config.name].blocks;
      const idx = blocks.findIndex(b=>b.id===blockId);
      if (idx >= 0 && idx + delta >= 0 && idx + delta < blocks.length) {
        [blocks[idx], blocks[idx+delta]] = [blocks[idx+delta], blocks[idx]];
        autoSave();
        switchTab(context);
      }
    }

    function uRef(context) {
      const wk = state.weeks[state.currentWeek];
      const stageData = wk[state.currentStage];
      if (context === 'group') {
        stageData.reflection = document.getElementById('groupReflection').value;
        stageData.reflectionTime = Date.now();
      } else {
        stageData.personal[config.name].reflection = document.getElementById('personalReflection').value;
        stageData.personal[config.name].reflectionTime = Date.now();
      }
      autoSave();
    }

    function runAI() {
      showToast('ü§ñ Running AI Assessment...');
      setTimeout(()=>{
        showToast('‚úÖ Assessment complete! Check the AI Coach for insights.');
        if (AIR[state.currentStage]) {
          const suggestions = AIR[state.currentStage].suggestions;
          suggestions.forEach(s=>{
            setTimeout(()=>addAIMessage(s), Math.random()*1000);
          });
        }
      }, 2000);
    }

    function toggleAICoach() {
      document.getElementById('aiCoachPanel').classList.toggle('open');
    }

    function addAIMessage(text) {
      const msgs = document.getElementById('aiMessages');
      const msg = document.createElement('div');
      msg.className = 'ai-message';
      msg.textContent = text;
      msgs.appendChild(msg);
      msgs.scrollTop = msgs.scrollHeight;
    }

    function sendAIMessage() {
      const input = document.getElementById('aiInput');
      const text = input.value.trim();
      if (!text) return;
      const msgs = document.getElementById('aiMessages');
      const userMsg = document.createElement('div');
      userMsg.className = 'user-message';
      userMsg.textContent = text;
      msgs.appendChild(userMsg);
      input.value = '';
      setTimeout(()=>{
        const stage = state.currentStage || 'empathize';
        const suggestions = AIR[stage] ? AIR[stage].suggestions : ['Keep exploring!'];
        const response = suggestions[Math.floor(Math.random()*suggestions.length)];
        addAIMessage(response);
        msgs.scrollTop = msgs.scrollHeight;
      }, 500);
    }

    function initDD() {
      const blocks = document.querySelectorAll('.block');
      blocks.forEach(block=>{
        const handle = block.querySelector('.block-handle');
        let offsetX = 0, offsetY = 0;
        handle.addEventListener('mousedown', (e)=>{
          block.classList.add('dragging');
          offsetX = e.clientX - block.getBoundingClientRect().left;
          offsetY = e.clientY - block.getBoundingClientRect().top;
        });
        document.addEventListener('mousemove', (e)=>{
          if (!block.classList.contains('dragging')) return;
          block.style.transform = `translate(${e.clientX - block.getBoundingClientRect().left - offsetX}px, ${e.clientY - block.getBoundingClientRect().top - offsetY}px)`;
        });
        document.addEventListener('mouseup', ()=>{
          block.classList.remove('dragging');
          block.style.transform = '';
        });
      });
    }

    function initRz() {
      const blocks = document.querySelectorAll('.block');
      blocks.forEach(block=>{
        const resizer = document.createElement('div');
        resizer.style.cssText = 'position:absolute;bottom:0;right:0;width:20px;height:20px;cursor:nwse-resize;background:rgba(99,102,241,0.3);border-radius:0 0 6px 0';
        block.style.position = 'relative';
        block.appendChild(resizer);
        let isResizing = false;
        let startWidth = 0, startHeight = 0, startX = 0, startY = 0;
        resizer.addEventListener('mousedown', (e)=>{
          isResizing = true;
          startWidth = block.offsetWidth;
          startHeight = block.offsetHeight;
          startX = e.clientX;
          startY = e.clientY;
        });
        document.addEventListener('mousemove', (e)=>{
          if (!isResizing) return;
          const newWidth = startWidth + (e.clientX - startX);
          const newHeight = startHeight + (e.clientY - startY);
          if (newWidth > 200) block.style.width = newWidth + 'px';
          if (newHeight > 200) block.style.height = newHeight + 'px';
        });
        document.addEventListener('mouseup', ()=>{
          isResizing = false;
          autoSave();
        });
      });
    }

    function mId() {
      return 'block_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function autoSave() {
      saveState();
      document.getElementById('syncDot').style.background = '#fbbf24';
      document.getElementById('syncLabel').textContent = 'Syncing...';
      setTimeout(()=>{
        document.getElementById('syncDot').style.background = '#10b981';
        document.getElementById('syncLabel').textContent = 'Synced';
      }, 1000);
    }

    function saveState() {
      localStorage.setItem('dt-v4', JSON.stringify(state.weeks));
      localStorage.setItem('dt-v4t', JSON.stringify(TD));
    }

    function showToast(msg) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(), 3000);
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('open');
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      authBootstrap();
    });
  </script>
</body>
</html>
