<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student ‚Äî Design Thinking Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,400;0,500;0,600;0,700;0,800&family=Lilita+One&display=swap" rel="stylesheet">
<style>
:root{--bg:#f0fdf4;--surface:#fff;--surface-2:#f7f8fc;--surface-3:#eef1f8;--border:#e0e4ef;--border-focus:#a5b4fc;--text:#1e293b;--text-muted:#64748b;--text-dim:#94a3b8;--shadow:0 2px 12px rgba(100,116,180,.08);--shadow-hover:0 6px 24px rgba(100,116,180,.14);--empathize:#ec4899;--define:#f97316;--ideate:#eab308;--prototype:#22c55e;--test:#3b82f6;--empathize-light:#fce7f3;--define-light:#fff7ed;--ideate-light:#fefce8;--prototype-light:#f0fdf4;--test-light:#eff6ff;--accent:#6366f1;--accent-light:#e0e7ff;--accent-glow:rgba(99,102,241,.15);--group-color:#3b82f6;--personal-color:#ec4899;--teacher:#7c3aed;--teacher-light:#f5f3ff;--teacher-border:#ddd6fe;--radius:14px;--radius-lg:20px}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}h1,h2,h3,.logo-text{font-family:'Lilita One',cursive;font-weight:400}
::-webkit-scrollbar{width:7px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}@keyframes pop{0%{transform:scale(.95);opacity:0}100%{transform:scale(1);opacity:1}}@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.4}}@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}
.top-nav{position:sticky;top:0;z-index:100;background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px;height:58px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 1px 6px rgba(0,0,0,.04)}
.logo{display:flex;align-items:center;gap:10px}.logo-icon{width:34px;height:34px;background:linear-gradient(135deg,var(--empathize),var(--accent),var(--test));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;color:#fff}.logo-text{font-size:1.15rem}
.nav-right{display:flex;align-items:center;gap:10px}
.role-switch{display:flex;background:var(--surface-3);border-radius:8px;padding:3px;border:1px solid var(--border)}.role-btn{padding:5px 12px;border:none;background:none;border-radius:6px;cursor:pointer;font-family:'Nunito',sans-serif;font-size:.75rem;font-weight:700;color:var(--text-muted);transition:all .2s}.role-btn.active{background:var(--accent);color:#fff}.role-btn.t-active{background:var(--teacher);color:#fff}
.sync-status{display:flex;align-items:center;gap:6px;font-size:.72rem;font-weight:700;color:var(--text-dim);padding:4px 10px;background:var(--surface-2);border-radius:20px;border:1px solid var(--border)}.sync-dot{width:7px;height:7px;border-radius:50%;background:#22c55e;animation:pulse-dot 2s infinite}
.group-badge{background:var(--group-color);color:#fff;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:800}
.avatar{width:32px;height:32px;border-radius:50%;background:var(--accent-light);color:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:800;cursor:pointer;position:relative}
.user-config{position:absolute;top:42px;right:0;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:var(--shadow-hover);z-index:110;width:260px;display:none}.user-config.open{display:block;animation:fadeUp .2s}
.user-config label{font-size:.7rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:4px}.user-config input{width:100%;padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Nunito',sans-serif;font-size:.85rem;color:var(--text);background:var(--surface-2);margin-bottom:8px}.user-config input:focus{outline:none;border-color:var(--accent)}
.cfg-btn{width:100%;background:var(--accent);color:#fff;border:none;padding:7px;border-radius:8px;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif;font-size:.82rem}
.view-container{padding:28px 24px 60px;max-width:1200px;margin:0 auto;animation:fadeUp .4s}
.map-header{text-align:center;margin-bottom:28px}.map-header h1{font-size:2rem;background:linear-gradient(135deg,var(--empathize),var(--accent),var(--test));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px}.map-header p{color:var(--text-muted);font-size:.92rem;max-width:500px;margin:0 auto}
.week-selector{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:24px}.week-nav-btn{background:var(--surface);border:1px solid var(--border);width:34px;height:34px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;color:var(--text-muted);transition:all .2s}.week-nav-btn:hover{border-color:var(--accent);color:var(--accent)}.week-nav-btn:disabled{opacity:.3;cursor:not-allowed}.week-display{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:7px 22px;font-weight:700;font-size:.9rem;min-width:160px;text-align:center;box-shadow:var(--shadow)}.add-week-btn{background:var(--accent);color:#fff;border:none;padding:7px 16px;border-radius:10px;font-weight:700;font-size:.8rem;cursor:pointer;font-family:'Nunito',sans-serif}
.announcement-bar{background:linear-gradient(135deg,var(--teacher-light),#eef2ff);border:2px solid var(--teacher-border);border-radius:var(--radius);padding:14px 18px;margin-bottom:18px;display:flex;align-items:flex-start;gap:10px;animation:fadeUp .35s}.ann-icon{font-size:1.2rem;flex-shrink:0;margin-top:2px}.ann-content{flex:1}.ann-title{font-weight:800;font-size:.85rem;color:var(--teacher);margin-bottom:2px}.ann-text{font-size:.85rem;color:var(--text-muted);line-height:1.5}
.modules-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:24px}
.module-card{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius-lg);padding:22px;cursor:pointer;transition:all .25s;position:relative;overflow:hidden;box-shadow:var(--shadow)}.module-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}.module-card[data-stage="empathize"]::before{background:var(--empathize)}.module-card[data-stage="define"]::before{background:var(--define)}.module-card[data-stage="ideate"]::before{background:var(--ideate)}.module-card[data-stage="prototype"]::before{background:var(--prototype)}.module-card[data-stage="test"]::before{background:var(--test)}.module-card:hover{transform:translateY(-3px);box-shadow:var(--shadow-hover);border-color:var(--accent)}.module-card.locked{opacity:.4;cursor:not-allowed;pointer-events:none}.module-card.locked::after{content:'üîí';position:absolute;top:10px;right:12px;font-size:1rem}
.card-top{display:flex;align-items:center;gap:12px;margin-bottom:8px}.stage-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}.stage-num{font-size:.65rem;text-transform:uppercase;letter-spacing:2px;font-weight:800}.module-card h3{font-size:1.15rem;margin-bottom:2px}.module-card .desc{color:var(--text-muted);font-size:.82rem;line-height:1.5;margin-bottom:14px}
.card-progress{display:flex;flex-direction:column;gap:6px}.progress-row{display:flex;align-items:center;gap:8px;font-size:.75rem}.progress-label{width:60px;font-weight:700;color:var(--text-muted)}.progress-bar{flex:1;height:7px;background:var(--surface-3);border-radius:4px;overflow:hidden}.progress-fill{height:100%;border-radius:4px;transition:width .5s}.progress-fill.group{background:linear-gradient(90deg,#60a5fa,var(--group-color))}.progress-fill.personal{background:linear-gradient(90deg,#f9a8d4,var(--personal-color))}.progress-fill.ai-score{background:linear-gradient(90deg,#a78bfa,var(--teacher))}.progress-pct{width:34px;text-align:right;font-weight:800}
.overall-progress{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius-lg);padding:20px 24px;display:flex;gap:28px;align-items:center;flex-wrap:wrap;box-shadow:var(--shadow)}.overall-progress h3{min-width:120px;font-size:1rem}.overall-bars{flex:1;display:flex;flex-direction:column;gap:8px;min-width:220px}.overall-bar-row{display:flex;align-items:center;gap:10px;font-size:.8rem}.overall-bar-row .progress-bar{height:10px;border-radius:5px}.overall-pct{font-family:'Lilita One',cursive;font-size:2.2rem;min-width:70px;text-align:center;color:var(--accent)}
.module-detail{display:none;padding:20px 24px 80px;max-width:1200px;margin:0 auto;animation:fadeUp .35s}.module-detail.active{display:block}
.back-btn{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:7px 16px;border-radius:10px;cursor:pointer;font-size:.82rem;font-weight:700;display:inline-flex;align-items:center;gap:6px;margin-bottom:16px;font-family:'Nunito',sans-serif;box-shadow:var(--shadow)}.back-btn:hover{border-color:var(--accent);color:var(--accent)}
.detail-header{margin-bottom:14px;display:flex;align-items:center;gap:14px;flex-wrap:wrap}.detail-header h2{font-size:1.5rem}.detail-progress-badges{margin-left:auto;display:flex;gap:10px}.progress-badge{text-align:center;background:var(--surface-2);padding:5px 12px;border-radius:10px;border:1px solid var(--border)}.progress-badge small{font-size:.55rem;text-transform:uppercase;letter-spacing:1px;font-weight:700;color:var(--text-muted);display:block}.progress-badge .pct-val{font-family:'Lilita One',cursive;font-size:1.2rem}
.tabs{display:flex;gap:3px;background:var(--surface-3);border-radius:10px;padding:3px;margin-bottom:14px;width:fit-content;border:1px solid var(--border)}.tab-btn{padding:7px 18px;border:none;background:none;color:var(--text-muted);border-radius:7px;cursor:pointer;font-size:.82rem;font-weight:700;transition:all .2s;font-family:'Nunito',sans-serif}.tab-btn.active{background:var(--accent);color:#fff}
.milestones-panel{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:16px;box-shadow:var(--shadow)}.milestones-panel h4{font-family:'Lilita One',cursive;font-weight:400;font-size:.95rem;color:var(--teacher);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.milestone-item{display:flex;align-items:flex-start;gap:10px;padding:10px;background:var(--surface-2);border-radius:10px;margin-bottom:7px;border:1.5px solid var(--border)}.milestone-weight{background:var(--teacher);color:#fff;padding:2px 9px;border-radius:20px;font-size:.7rem;font-weight:800;flex-shrink:0}.milestone-info{flex:1;min-width:0}.milestone-name{font-weight:700;font-size:.85rem;margin-bottom:2px}.milestone-desc{font-size:.78rem;color:var(--text-muted)}.milestone-evidence{margin-top:6px;display:flex;flex-wrap:wrap;gap:5px}
.evidence-tag{font-size:.7rem;padding:3px 9px;border-radius:6px;background:var(--accent-light);color:var(--accent);font-weight:700;cursor:pointer;display:flex;align-items:center;gap:3px;border:1px solid transparent}.evidence-tag:hover{border-color:var(--accent)}.evidence-tag .remove-ev{font-size:.6rem;opacity:.6}.evidence-tag .remove-ev:hover{opacity:1}
.link-evidence-btn{font-size:.7rem;padding:3px 9px;border-radius:6px;background:none;border:1.5px dashed var(--border);color:var(--text-muted);font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif}.link-evidence-btn:hover{border-color:var(--accent);color:var(--accent)}
.milestone-score{display:flex;align-items:center;gap:5px;flex-shrink:0}.score-badge{padding:3px 9px;border-radius:7px;font-size:.75rem;font-weight:800;background:var(--surface-3);color:var(--text-muted)}.score-badge.scored{background:#dcfce7;color:#16a34a}
.ai-score-panel{background:linear-gradient(135deg,#f5f3ff,#eef2ff);border:2px solid var(--teacher-border);border-radius:var(--radius);padding:18px;margin-bottom:16px}.ai-score-panel h4{font-family:'Lilita One',cursive;font-weight:400;font-size:.95rem;color:var(--teacher);margin-bottom:4px}.ai-score-summary{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-top:10px}.ai-total-score{font-family:'Lilita One',cursive;font-size:2.4rem;color:var(--teacher)}.ai-breakdown{flex:1;font-size:.82rem;color:var(--text-muted);line-height:1.5}.run-ai-btn{background:var(--teacher);color:#fff;border:none;padding:9px 20px;border-radius:10px;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif;font-size:.85rem;display:flex;align-items:center;gap:6px;transition:all .2s;flex-shrink:0}.run-ai-btn:hover{opacity:.85}.run-ai-btn.running{background:var(--surface-3);color:var(--text-muted);pointer-events:none}.ai-feedback{margin-top:10px;padding:10px;background:rgba(255,255,255,.6);border-radius:10px;font-size:.82rem;line-height:1.6;white-space:pre-line}
.canvas-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;align-items:start;min-height:180px}
.block{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);animation:pop .3s;transition:all .2s;position:relative;min-height:110px}.block:hover{border-color:var(--border-focus)}.block.dragging{opacity:.5;transform:scale(.97)}.block.drag-over{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}.block.resizing{border-color:var(--accent)!important;user-select:none}
.block-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--surface-2);border-bottom:1px solid var(--border);cursor:grab;user-select:none}.block-header:active{cursor:grabbing}
.drag-handle{color:var(--text-dim);font-size:.95rem;margin-right:5px;cursor:grab}
.block-title{font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:.7px;color:var(--text-muted);display:flex;align-items:center;gap:4px;flex:1;min-width:0}.block-title .icon{font-size:.9rem;flex-shrink:0}.block-title-text{outline:none;min-width:30px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.block-author{font-size:.65rem;font-weight:700;padding:2px 6px;border-radius:5px;margin-left:3px;flex-shrink:0}.block-author.self{background:var(--accent-light);color:var(--accent)}.block-author.other{background:#fef3c7;color:#b45309}
.block-type-badge{font-size:.52rem;padding:2px 5px;border-radius:4px;font-weight:800;text-transform:uppercase;flex-shrink:0}.block-type-badge.notes{background:#dbeafe;color:#2563eb}.block-type-badge.photos{background:#fce7f3;color:#db2777}.block-type-badge.checklist{background:#dcfce7;color:#16a34a}.block-type-badge.freeform{background:#fef3c7;color:#d97706}
.block-actions{display:flex;gap:2px;flex-shrink:0;margin-left:4px}.block-action-btn,.span-toggle{background:none;border:1px solid transparent;color:var(--text-dim);cursor:pointer;width:24px;height:24px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:.75rem;transition:all .15s;padding:0}.block-action-btn:hover{background:var(--surface-3);color:var(--text)}.block-action-btn.danger:hover{background:#fee2e2;color:#ef4444}.span-toggle{border-color:var(--border)}.span-toggle:hover{background:var(--accent-light);color:var(--accent)}.span-toggle.active{background:var(--accent);color:#fff}
.block-body{padding:12px}
.block-textarea{width:100%;min-height:80px;background:var(--surface-2);border:1.5px solid var(--border);border-radius:9px;color:var(--text);padding:10px 12px;font-family:'Nunito',sans-serif;font-size:.88rem;line-height:1.6;resize:vertical}.block-textarea:focus{outline:none;border-color:var(--accent);background:#fff}.block-textarea::placeholder{color:var(--text-dim)}
.block-photos{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:7px;margin-bottom:8px}.photo-thumb{aspect-ratio:1;border-radius:9px;overflow:hidden;position:relative;border:1.5px solid var(--border)}.photo-thumb img{width:100%;height:100%;object-fit:cover}.photo-thumb .remove-photo{position:absolute;top:3px;right:3px;width:18px;height:18px;background:rgba(0,0,0,.6);border:none;border-radius:50%;color:#fff;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;opacity:0}.photo-thumb:hover .remove-photo{opacity:1}
.upload-zone{display:flex;align-items:center;justify-content:center;gap:6px;padding:14px;background:var(--surface-2);border:2px dashed var(--border);border-radius:9px;color:var(--text-muted);cursor:pointer;font-size:.82rem;font-weight:600;font-family:'Nunito',sans-serif}.upload-zone:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}
.block-checklist{display:flex;flex-direction:column;gap:4px}.check-item{display:flex;align-items:flex-start;gap:8px;padding:7px 10px;background:var(--surface-2);border-radius:8px;font-size:.88rem}.check-item input[type="checkbox"]{accent-color:var(--accent);width:16px;height:16px;margin-top:2px;flex-shrink:0}.check-item.checked .check-item-text{text-decoration:line-through;color:var(--text-dim)}.check-item-text{flex:1;background:none;border:none;color:var(--text);font-family:'Nunito',sans-serif;font-size:.88rem;outline:none}
.add-check-btn{background:none;border:1.5px dashed var(--border);color:var(--text-muted);padding:6px 10px;border-radius:8px;cursor:pointer;font-size:.8rem;font-weight:600;font-family:'Nunito',sans-serif;margin-top:3px}.add-check-btn:hover{border-color:var(--accent);color:var(--accent)}
.add-block-area{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap}.add-block-btn{background:var(--surface);border:2px dashed var(--border);border-radius:var(--radius);padding:10px 18px;cursor:pointer;font-family:'Nunito',sans-serif;font-weight:700;font-size:.82rem;color:var(--text-muted);display:flex;align-items:center;gap:6px;transition:all .2s}.add-block-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}
.block-footer{padding:6px 12px;border-top:1px solid var(--border);display:flex;align-items:center;gap:8px;background:var(--surface-2)}.like-btn,.comment-toggle{background:none;border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:.72rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:4px;font-family:'Nunito',sans-serif;color:var(--text-muted);transition:all .15s}.like-btn:hover,.like-btn.liked{border-color:#ef4444;color:#ef4444;background:#fef2f2}.comment-toggle:hover{border-color:var(--accent);color:var(--accent)}
.block-comments{padding:8px 12px;border-top:1px solid var(--border);background:var(--surface-2);display:none}.block-comments.open{display:block;animation:fadeUp .2s}.comment-list{display:flex;flex-direction:column;gap:6px;margin-bottom:6px;max-height:180px;overflow-y:auto}.comment{padding:7px 9px;background:var(--surface);border-radius:7px;border:1px solid var(--border)}.comment-header{display:flex;justify-content:space-between;margin-bottom:2px}.comment-author{font-size:.72rem;font-weight:800;color:var(--accent)}.comment-author.teacher-comment{color:var(--teacher)}.comment-time{font-size:.62rem;color:var(--text-dim)}.comment-text{font-size:.82rem;line-height:1.4}
.comment-input-row{display:flex;gap:5px}.comment-input{flex:1;padding:6px 10px;border:1.5px solid var(--border);border-radius:7px;font-family:'Nunito',sans-serif;font-size:.82rem;background:var(--surface)}.comment-input:focus{outline:none;border-color:var(--accent)}.comment-send{background:var(--accent);color:#fff;border:none;border-radius:7px;padding:0 12px;cursor:pointer;font-weight:800;font-size:.85rem}
.block-timestamp{font-size:.62rem;color:var(--text-dim);padding:0 12px 5px;font-weight:600}
.resize-handle{position:absolute;z-index:5;opacity:0;transition:opacity .15s}.block:hover .resize-handle{opacity:1}.resize-handle-bottom{left:10px;right:10px;bottom:-4px;height:8px;cursor:ns-resize;display:flex;align-items:center;justify-content:center}.resize-handle-bottom::after{content:'';width:28px;height:3px;background:var(--accent);border-radius:2px;opacity:.5}.resize-handle-corner{right:-4px;bottom:-4px;width:14px;height:14px;cursor:nwse-resize}.resize-handle-corner::after{content:'';position:absolute;right:3px;bottom:3px;width:7px;height:7px;border-right:2px solid var(--accent);border-bottom:2px solid var(--accent);opacity:.5}.resize-handle:hover::after{opacity:1}.resize-tooltip{position:fixed;background:var(--text);color:#fff;padding:3px 9px;border-radius:5px;font-size:.7rem;font-weight:700;pointer-events:none;z-index:1000;display:none}.resize-tooltip.show{display:block}
.reflection-section{margin-top:18px}.reflection-card{background:linear-gradient(135deg,#fdf4ff,#f0f0ff,#f0f9ff);border:2px solid #e9d5ff;border-radius:var(--radius-lg);padding:20px}.reflection-card h4{font-family:'Lilita One',cursive;font-size:.95rem;color:#7c3aed;margin-bottom:10px;display:flex;align-items:center;gap:8px;font-weight:400}.reflection-prompts{display:flex;flex-direction:column;gap:10px}.reflection-prompt label{display:block;font-size:.82rem;color:var(--text-muted);margin-bottom:4px;font-style:italic;font-weight:600}.reflection-prompt .block-textarea{min-height:60px;background:rgba(255,255,255,.7)}.reflection-prompt .block-textarea:focus{background:#fff}
.teacher-view{animation:fadeUp .4s}.teacher-card{background:var(--surface);border:2px solid var(--teacher-border);border-radius:var(--radius-lg);padding:22px;margin-bottom:18px;box-shadow:var(--shadow)}.teacher-card h3{font-size:1.05rem;color:var(--teacher);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.t-input-group{margin-bottom:12px}.t-input-group label{font-size:.72rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:4px}.t-input,.t-textarea{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'Nunito',sans-serif;font-size:.88rem;color:var(--text);background:var(--surface-2)}.t-textarea{min-height:70px;resize:vertical;line-height:1.5}.t-input:focus,.t-textarea:focus{outline:none;border-color:var(--teacher)}
.t-btn{background:var(--teacher);color:#fff;border:none;padding:9px 20px;border-radius:10px;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif;font-size:.85rem}
.stage-toggle{display:flex;align-items:center;gap:8px;padding:9px 12px;background:var(--surface-2);border-radius:9px;margin-bottom:7px;border:1.5px solid var(--border)}.stage-toggle label{flex:1;font-weight:600;font-size:.88rem;display:flex;align-items:center;gap:7px;cursor:pointer}.stage-toggle input[type="checkbox"]{accent-color:var(--teacher);width:17px;height:17px}
.milestone-editor{padding:10px;background:var(--surface-2);border-radius:9px;margin-top:7px;border:1px solid var(--border)}.milestone-editor-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}.milestone-editor-row .t-input{flex:1}.weight-input{width:60px!important;text-align:center;flex:none!important}.remove-milestone-btn{background:none;border:none;color:#ef4444;cursor:pointer;font-size:1rem;padding:3px}.add-milestone-btn{background:none;border:1.5px dashed var(--teacher-border);color:var(--teacher);padding:6px 12px;border-radius:8px;cursor:pointer;font-family:'Nunito',sans-serif;font-weight:700;font-size:.8rem;width:100%}.add-milestone-btn:hover{background:var(--teacher-light)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:300;display:flex;align-items:center;justify-content:center}.modal{background:var(--surface);border-radius:var(--radius-lg);padding:24px;max-width:460px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 12px 40px rgba(0,0,0,.2)}.modal h3{font-size:1.05rem;margin-bottom:14px}.modal-block-item{padding:9px 12px;background:var(--surface-2);border:1.5px solid var(--border);border-radius:9px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:.85rem;font-weight:600}.modal-block-item:hover,.modal-block-item.selected{border-color:var(--accent);background:var(--accent-light)}.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:14px}.modal-close{background:none;border:1px solid var(--border);padding:7px 16px;border-radius:8px;cursor:pointer;font-weight:700;font-family:'Nunito',sans-serif}.modal-confirm{background:var(--accent);color:#fff;border:none;padding:7px 16px;border-radius:8px;cursor:pointer;font-weight:700;font-family:'Nunito',sans-serif}
.group-online{display:flex;align-items:center;gap:5px;margin-bottom:12px;padding:7px 12px;background:var(--surface);border:1px solid var(--border);border-radius:9px;font-size:.78rem;color:var(--text-muted);font-weight:600}.online-avatars{display:flex;margin-left:4px}.online-avatar{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:800;margin-left:-5px;border:2px solid var(--surface);color:#fff}.online-avatar:first-child{margin-left:0}
.ai-toggle{position:fixed;right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#7c3aed);border:none;cursor:pointer;z-index:95;display:flex;align-items:center;justify-content:center;font-size:22px;color:#fff;box-shadow:0 4px 18px var(--accent-glow)}.ai-toggle:hover{transform:scale(1.08)}
.ai-panel{position:fixed;right:-420px;top:0;bottom:0;width:400px;background:var(--surface);border-left:1px solid var(--border);z-index:200;display:flex;flex-direction:column;transition:right .35s cubic-bezier(.4,0,.2,1);box-shadow:-4px 0 24px rgba(0,0,0,.08)}.ai-panel.open{right:0}
.ai-header{padding:12px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,#eef2ff,#fdf4ff)}.ai-header h3{font-family:'Lilita One',cursive;font-weight:400;font-size:1rem;display:flex;align-items:center;gap:7px;color:var(--accent)}.ai-close{background:var(--surface-3);border:none;color:var(--text-muted);cursor:pointer;width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:.95rem}.ai-close:hover{background:var(--border);color:var(--text)}
.ai-context{padding:6px 18px;background:var(--surface-2);font-size:.72rem;font-weight:600;color:var(--text-muted);border-bottom:1px solid var(--border)}
.ai-messages{flex:1;overflow-y:auto;padding:12px 18px;display:flex;flex-direction:column;gap:8px}.ai-msg{max-width:88%;padding:9px 13px;border-radius:12px;font-size:.85rem;line-height:1.5;animation:fadeUp .25s}.ai-msg.bot{background:var(--surface-2);border:1px solid var(--border);align-self:flex-start;border-bottom-left-radius:4px}.ai-msg.user{background:var(--accent);color:#fff;align-self:flex-end;border-bottom-right-radius:4px;font-weight:600}
.ai-suggestions{padding:6px 14px;display:flex;flex-wrap:wrap;gap:4px}.ai-suggestion{background:var(--surface-2);border:1px solid var(--border);color:var(--text-muted);padding:4px 11px;border-radius:20px;font-size:.72rem;cursor:pointer;font-family:'Nunito',sans-serif;font-weight:600}.ai-suggestion:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}
.ai-input-area{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:6px;background:var(--surface-2)}.ai-input{flex:1;background:var(--surface);border:1.5px solid var(--border);border-radius:9px;padding:8px 12px;color:var(--text);font-size:.85rem;font-family:'Nunito',sans-serif}.ai-input:focus{outline:none;border-color:var(--accent)}.ai-send{background:var(--accent);border:none;border-radius:9px;padding:0 14px;cursor:pointer;font-size:1.05rem;color:#fff;font-weight:800}
.typing-dots{display:inline-flex;gap:3px;padding:3px 0}.typing-dots span{width:6px;height:6px;background:var(--text-dim);border-radius:50%;animation:bounce 1.4s infinite}.typing-dots span:nth-child(2){animation-delay:.2s}.typing-dots span:nth-child(3){animation-delay:.4s}
.sync-toast{position:fixed;bottom:20px;left:20px;background:var(--surface);border:1px solid var(--border);padding:8px 16px;border-radius:12px;font-size:.8rem;font-weight:700;z-index:200;box-shadow:var(--shadow-hover);opacity:0;transform:translateY(10px);transition:all .3s;pointer-events:none}.sync-toast.show{opacity:1;transform:translateY(0)}.sync-toast.saved{color:#16a34a;border-color:#86efac}.sync-toast.synced{color:#2563eb;border-color:#93c5fd}
.hidden-input{display:none}
@media(max-width:768px){.modules-grid{grid-template-columns:1fr}.canvas-grid{grid-template-columns:1fr}.canvas-grid .block{grid-column:span 1!important}.overall-progress{flex-direction:column;gap:14px}.ai-panel{width:100%;right:-100%}.detail-progress-badges{margin-left:0}.top-nav{padding:0 12px}.role-switch{display:none}}
</style>
</head>
<body>
<nav class="top-nav"><div class="logo"><div class="logo-icon">üí°</div><span class="logo-text">Student Portal</span></div><div class="nav-right"><div class="sync-status"><div class="sync-dot" id="syncDot"></div><span id="syncLabel">Synced</span></div><span class="group-badge" id="groupBadge">Group 3</span><span style="font-weight:700;font-size:.85rem" id="navName">Student</span><div class="avatar" id="avatarBtn" onclick="toggleConfig()"><span id="avatarInitials">ST</span><div class="user-config" id="userConfig"><label>Your Name</label><input type="text" id="configName" placeholder="e.g. Joe" /><label>Group</label><input type="text" id="configGroup" placeholder="e.g. Group 3" /><label>Members (comma sep)</label><input type="text" id="configMembers" placeholder="Joe, Sarah, Wei Lin" /><button class="cfg-btn" onclick="saveConfig(event)">Save</button></div></div><a href="#" onclick="logout(); return false;" style="margin-left:8px;font-size:.75rem;font-weight:700;color:var(--text-muted);text-decoration:none">Log out</a></div></nav>
<div id="studentView"></div><div id="teacherView" style="display:none!important"></div><div id="moduleDetail" class="module-detail"></div><div id="modalContainer"></div>
<button class="ai-toggle" id="aiToggle">ü§ñ</button>
<div class="ai-panel" id="aiPanel"><div class="ai-header"><h3>ü§ñ DT Coach</h3><button class="ai-close" id="aiClose">‚úï</button></div><div class="ai-context" id="aiContext">üí° Ask me anything about Design Thinking</div><div class="ai-messages" id="aiMessages"><div class="ai-msg bot">Hey! üëã I'm your Design Thinking coach. Ask me anything!</div></div><div class="ai-suggestions" id="aiSuggestions"><button class="ai-suggestion" onclick="askAI(this.textContent)">How do I interview users?</button><button class="ai-suggestion" onclick="askAI(this.textContent)">Help write a problem statement</button><button class="ai-suggestion" onclick="askAI(this.textContent)">What makes a good prototype?</button></div><div class="ai-input-area"><input class="ai-input" id="aiInput" placeholder="Ask your DT Coach..." /><button class="ai-send" onclick="sendAI()">‚Üí</button></div></div>
<div class="sync-toast" id="syncToast"></div><div class="resize-tooltip" id="resizeTooltip"></div>
<script>
const MC=['#3b82f6','#ec4899','#22c55e','#f97316','#8b5cf6','#ef4444','#06b6d4','#eab308'];
const STAGES=[{id:'empathize',name:'Empathize',icon:'‚ù§Ô∏è',color:'#ec4899',bg:'#fce7f3',desc:'Research user needs through observation and interviews.'},{id:'define',name:'Define',icon:'üéØ',color:'#f97316',bg:'#fff7ed',desc:'Synthesize findings into a human-centered problem statement.'},{id:'ideate',name:'Ideate',icon:'üí°',color:'#eab308',bg:'#fefce8',desc:'Brainstorm creative ideas ‚Äî go wild!'},{id:'prototype',name:'Prototype',icon:'üîß',color:'#22c55e',bg:'#f0fdf4',desc:'Build a rough, testable version of your solution.'},{id:'test',name:'Test',icon:'üß™',color:'#3b82f6',bg:'#eff6ff',desc:'Get real feedback. Listen, observe, refine.'}];
let config={name:'Student',group:'Group 3',members:['Student']};
async function authBootstrap(){const r=await fetch('/api/auth/me');if(!r.ok){window.location.href='/login.html';return;}const u=await r.json();if(u.role!=='student'){window.location.href=u.role==='admin'?'/admin.html':'/teacher.html';return;}config.name=u.name||config.name;config.group=u.group||config.group;if(Array.isArray(u.members)&&u.members.length)config.members=u.members;localStorage.setItem('dt-config',JSON.stringify(config));state.role='student';}
function logout(){fetch('/api/auth/logout',{method:'POST'}).then(()=>{window.location.href='/login.html';});}
function loadConfig(){const s=localStorage.getItem('dt-config');if(s)try{Object.assign(config,JSON.parse(s))}catch(e){};applyConfig()}
function applyConfig(){document.getElementById('navName').textContent=config.name;document.getElementById('groupBadge').textContent=config.group;document.getElementById('avatarInitials').textContent=(config.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2))||'ST';document.getElementById('configName').value=config.name;document.getElementById('configGroup').value=config.group;document.getElementById('configMembers').value=config.members.join(', ')}
function toggleConfig(){document.getElementById('userConfig').classList.toggle('open')}
function saveConfig(e){e.stopPropagation();config.name=document.getElementById('configName').value.trim()||'Student';config.group=document.getElementById('configGroup').value.trim()||'Group 3';config.members=document.getElementById('configMembers').value.split(',').map(s=>s.trim()).filter(Boolean);if(!config.members.includes(config.name))config.members.unshift(config.name);localStorage.setItem('dt-config',JSON.stringify(config));applyConfig();toggleConfig();showToast('saved','‚úì Saved')}
document.addEventListener('click',e=>{if(!e.target.closest('#avatarBtn'))document.getElementById('userConfig').classList.remove('open')});
let state={currentWeek:1,totalWeeks:1,currentStage:null,currentTab:'group',role:'student',weeks:{}};
let TD={announcements:{},weekConfigs:{}};
function mId(){return 'b'+Date.now()+Math.random().toString(36).slice(2,5)}
function gWK(){return 'week'+state.currentWeek}
function gTC(){const w=gWK();if(!TD.weekConfigs[w]){TD.weekConfigs[w]={openStages:['empathize'],announcement:'',stages:{}};STAGES.forEach(s=>{TD.weekConfigs[w].stages[s.id]={milestones:[{id:mId(),name:'Complete initial research',desc:'Document at least 2 user interactions',weight:30},{id:mId(),name:'Visual documentation',desc:'Upload photo evidence',weight:20},{id:mId(),name:'Team collaboration',desc:'All members contribute',weight:25},{id:mId(),name:'Reflection',desc:'Complete reflection',weight:25}],rubric:'Evaluate depth, evidence quality, collaboration, and critical thinking.'}})}return TD.weekConfigs[w]}
function gWD(){const w=gWK();if(!state.weeks[w]){state.weeks[w]={};STAGES.forEach(s=>{state.weeks[w][s.id]={group:{blocks:[{id:mId(),type:'notes',title:'Group Notes',placeholder:'Document findings...',author:config.name,createdAt:new Date().toISOString(),data:'',likes:[],comments:[]},{id:mId(),type:'photos',title:'Evidence',author:config.name,createdAt:new Date().toISOString(),data:[],likes:[],comments:[]}]},personal:{blocks:[{id:mId(),type:'notes',title:'My Notes',placeholder:'Your observations...',author:null,createdAt:new Date().toISOString(),data:'',likes:[],comments:[]}]},reflections:['',''],aiScore:null,aiFeedback:'',milestoneEvidence:{},milestoneScores:{}}})}return state.weeks[w]}
function loadState(){let s=localStorage.getItem('dt-v4');if(s)try{Object.assign(state,JSON.parse(s))}catch(e){};let t=localStorage.getItem('dt-v4t');if(t)try{Object.assign(TD,JSON.parse(t))}catch(e){}}
function saveState(){localStorage.setItem('dt-v4',JSON.stringify(state));localStorage.setItem('dt-v4t',JSON.stringify(TD))}
let sT;function autoSave(){clearTimeout(sT);sT=setTimeout(()=>{saveState();showToast('saved','‚úì Saved')},600)}
function showToast(t,m){const el=document.getElementById('syncToast');el.className='sync-toast '+t;el.textContent=m;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1800)}
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function gMC(n){const i=config.members.indexOf(n);return MC[i>=0?i%MC.length:0]}
function switchRole(r){state.role=r;document.getElementById('roleStudent').className='role-btn'+(r==='student'?' active':'');document.getElementById('roleTeacher').className='role-btn'+(r==='teacher'?' t-active active':'');if(r==='teacher'){document.getElementById('studentView').style.display='none';document.getElementById('teacherView').style.display='block';document.getElementById('moduleDetail').classList.remove('active');renderTeacher()}else{document.getElementById('teacherView').style.display='none';document.getElementById('studentView').style.display='block';state.currentStage=null;document.getElementById('moduleDetail').classList.remove('active');renderStudentMap()}}
function renderTeacher(){const tc=gTC();document.getElementById('teacherView').innerHTML=`<div class="view-container teacher-view"><div class="map-header"><h1>üë©‚Äçüè´ Teacher Dashboard</h1><p>Configure tasks, milestones, and review progress.</p></div><div class="week-selector"><button class="week-nav-btn" ${state.currentWeek<=1?'disabled':''} onclick="changeWeek(-1)">‚Äπ</button><div class="week-display">Week ${state.currentWeek}</div><button class="week-nav-btn" ${state.currentWeek>=state.totalWeeks?'disabled':''} onclick="changeWeek(1)">‚Ä∫</button><button class="add-week-btn" onclick="addWeek()">+ New Week</button></div><div class="teacher-card"><h3>üì¢ Announcement</h3><div class="t-input-group"><label>Message for students</label><textarea class="t-textarea" placeholder="e.g. This week: user interviews!" oninput="gTC().announcement=this.value;autoSave()">${esc(tc.announcement)}</textarea></div></div><div class="teacher-card"><h3>üîì Open Stages</h3><p style="font-size:.82rem;color:var(--text-muted);margin-bottom:12px">Only checked stages visible to students.</p>${STAGES.map((s,i)=>`<div class="stage-toggle"><label><input type="checkbox" ${tc.openStages.includes(s.id)?'checked':''} onchange="tcToggle('${s.id}',this.checked)" /><span style="font-size:1rem">${s.icon}</span> Stage ${i+1}: ${s.name}</label></div>`).join('')}</div>${tc.openStages.map(sid=>{const s=STAGES.find(x=>x.id===sid);const sc=tc.stages[sid];const tw=sc.milestones.reduce((a,m)=>a+m.weight,0);return`<div class="teacher-card"><h3>${s.icon} ${s.name} ‚Äî Milestones <span style="font-size:.72rem;font-weight:600;color:${tw===100?'#16a34a':'#ef4444'};margin-left:6px">(${tw}%)</span></h3>${sc.milestones.map((m,mi)=>`<div class="milestone-editor"><div class="milestone-editor-row"><input class="t-input" value="${esc(m.name)}" placeholder="Name" onchange="tcUM('${sid}',${mi},'name',this.value)" /><input class="t-input weight-input" type="number" min="0" max="100" value="${m.weight}" onchange="tcUM('${sid}',${mi},'weight',parseInt(this.value))" /><span style="font-size:.78rem;color:var(--text-muted)">%</span><button class="remove-milestone-btn" onclick="tcRM('${sid}',${mi})">‚úï</button></div><input class="t-input" value="${esc(m.desc)}" placeholder="Description" style="margin-top:3px" onchange="tcUM('${sid}',${mi},'desc',this.value)" /></div>`).join('')}<button class="add-milestone-btn" onclick="tcAM('${sid}')">+ Add Milestone</button><div class="t-input-group" style="margin-top:12px"><label>AI Rubric</label><textarea class="t-textarea" placeholder="How should AI evaluate..." oninput="gTC().stages['${sid}'].rubric=this.value;autoSave()">${esc(sc.rubric)}</textarea></div></div>`}).join('')}<div class="teacher-card"><h3>üìä Group Overview</h3>${tc.openStages.map(sid=>{const s=STAGES.find(x=>x.id===sid);const wd=gWD();const sc=wd[sid]?.aiScore;return`<div class="progress-row" style="margin-bottom:4px"><span class="progress-label">${s.icon} ${s.name}</span><div class="progress-bar"><div class="progress-fill ai-score" style="width:${sc||0}%"></div></div><span class="progress-pct" style="color:var(--teacher)">${sc!=null?sc+'%':'‚Äî'}</span></div>`}).join('')}</div></div>`}
function tcToggle(sid,c){const tc=gTC();if(c){if(!tc.openStages.includes(sid))tc.openStages.push(sid)}else tc.openStages=tc.openStages.filter(s=>s!==sid);autoSave();renderTeacher()}
function tcUM(sid,i,f,v){gTC().stages[sid].milestones[i][f]=v;autoSave();renderTeacher()}
function tcRM(sid,i){gTC().stages[sid].milestones.splice(i,1);autoSave();renderTeacher()}
function tcAM(sid){gTC().stages[sid].milestones.push({id:mId(),name:'',desc:'',weight:10});autoSave();renderTeacher()}
function cBP(b){if(b.type==='notes'||b.type==='freeform')return(typeof b.data==='string'&&b.data.trim().length>15)?1:0;if(b.type==='photos')return(Array.isArray(b.data)&&b.data.length>0)?1:0;if(b.type==='checklist'){if(!Array.isArray(b.data)||!b.data.length)return 0;return b.data.filter(i=>i.done).length/b.data.length}return 0}
function cGP(sid){const bl=gWD()[sid]?.group?.blocks||[];if(!bl.length)return 0;return Math.round(bl.reduce((s,b)=>s+cBP(b),0)/bl.length*100)}
function cO(t){const tc=gTC();const o=tc.openStages;if(!o.length)return 0;if(t==='ai')return Math.round(o.reduce((s,sid)=>s+(gWD()[sid]?.aiScore||0),0)/o.length);return Math.round(o.reduce((s,sid)=>s+cGP(sid),0)/o.length)}
function renderStudentMap(){const tc=gTC();gWD();let ann='';if(tc.announcement)ann=`<div class="announcement-bar"><div class="ann-icon">üì¢</div><div class="ann-content"><div class="ann-title">Teacher Announcement</div><div class="ann-text">${esc(tc.announcement)}</div></div></div>`;document.getElementById('studentView').innerHTML=`<div class="view-container"><div class="map-header"><h1>Design Thinking Journey</h1><p>Click any open stage to document your process.</p></div><div class="week-selector"><button class="week-nav-btn" ${state.currentWeek<=1?'disabled':''} onclick="changeWeek(-1)">‚Äπ</button><div class="week-display">Week ${state.currentWeek}</div><button class="week-nav-btn" ${state.currentWeek>=state.totalWeeks?'disabled':''} onclick="changeWeek(1)">‚Ä∫</button></div>${ann}<div class="modules-grid">${STAGES.map((s,i)=>{const op=tc.openStages.includes(s.id);const sc=gWD()[s.id]?.aiScore||0;const gp=cGP(s.id);return`<div class="module-card ${op?'':'locked'}" data-stage="${s.id}" ${op?`onclick="openStage('${s.id}')"`:''}><div class="card-top"><div class="stage-icon" style="background:${s.bg}">${s.icon}</div><div><div class="stage-num" style="color:${s.color}">Stage ${i+1}</div><h3>${s.name}</h3></div></div><p class="desc">${s.desc}</p><div class="card-progress"><div class="progress-row"><span class="progress-label">Group</span><div class="progress-bar"><div class="progress-fill group" style="width:${gp}%"></div></div><span class="progress-pct" style="color:var(--group-color)">${gp}%</span></div><div class="progress-row"><span class="progress-label">AI Score</span><div class="progress-bar"><div class="progress-fill ai-score" style="width:${sc}%"></div></div><span class="progress-pct" style="color:var(--teacher)">${sc?sc+'%':'‚Äî'}</span></div></div></div>`}).join('')}</div><div class="overall-progress"><div><h3>Overall</h3></div><div class="overall-bars"><div class="overall-bar-row"><span class="progress-label" style="color:var(--group-color);font-weight:800">ü§ù Group</span><div class="progress-bar"><div class="progress-fill group" style="width:${cO('group')}%"></div></div><span class="progress-pct" style="color:var(--group-color)">${cO('group')}%</span></div><div class="overall-bar-row"><span class="progress-label" style="color:var(--teacher);font-weight:800">ü§ñ AI</span><div class="progress-bar"><div class="progress-fill ai-score" style="width:${cO('ai')}%"></div></div><span class="progress-pct" style="color:var(--teacher)">${cO('ai')}%</span></div></div><div class="overall-pct">${cO('group')}%</div></div></div>`}
function changeWeek(d){const n=state.currentWeek+d;if(n<1||n>state.totalWeeks)return;state.currentWeek=n;gWD();gTC();if(state.role==='teacher')renderTeacher();else{state.currentStage?renderDetail():renderStudentMap()};autoSave()}
function addWeek(){state.totalWeeks++;state.currentWeek=state.totalWeeks;gWD();gTC();autoSave();if(state.role==='teacher')renderTeacher();else renderStudentMap();showToast('saved','‚úì Week '+state.totalWeeks)}
function openStage(sid){state.currentStage=sid;state.currentTab='group';document.getElementById('studentView').style.display='none';document.getElementById('moduleDetail').classList.add('active');renderDetail();window.scrollTo(0,0)}
function goBack(){state.currentStage=null;document.getElementById('studentView').style.display='block';document.getElementById('moduleDetail').classList.remove('active');renderStudentMap()}
function switchTab(t){state.currentTab=t;renderDetail()}
function renderDetail(){const stage=STAGES.find(s=>s.id===state.currentStage);const wd=gWD();const sd=wd[stage.id];const tc=gTC();const tab=state.currentTab;const blocks=sd[tab].blocks;const isG=tab==='group';const sc=tc.stages[stage.id];const gp=cGP(stage.id);
let ann='';if(tc.announcement)ann=`<div class="announcement-bar"><div class="ann-icon">üì¢</div><div class="ann-content"><div class="ann-title">Teacher Announcement</div><div class="ann-text">${esc(tc.announcement)}</div></div></div>`;
let online='';if(isG&&config.members.length>1)online=`<div class="group-online"><span>üë•</span><div class="online-avatars">${config.members.map((m,i)=>`<div class="online-avatar" style="background:${MC[i%MC.length]}">${m[0]?.toUpperCase()||'?'}</div>`).join('')}</div><span style="margin-left:6px;color:var(--text-dim);font-size:.72rem">syncs /30s</span></div>`;
let mHTML='';if(isG&&sc?.milestones?.length){mHTML=`<div class="milestones-panel"><h4>üéØ Milestones & Weightage</h4>${sc.milestones.map(m=>{const ev=sd.milestoneEvidence[m.id]||[];const score=sd.milestoneScores[m.id];return`<div class="milestone-item"><div class="milestone-weight">${m.weight}%</div><div class="milestone-info"><div class="milestone-name">${esc(m.name)}</div><div class="milestone-desc">${esc(m.desc)}</div><div class="milestone-evidence">${ev.map((e,ei)=>`<span class="evidence-tag">${esc(e.title)} <span class="remove-ev" onclick="unlinkEv('${m.id}',${ei})">‚úï</span></span>`).join('')}<button class="link-evidence-btn" onclick="openLinkModal('${m.id}')">+ Link evidence</button></div></div><div class="milestone-score"><span class="score-badge ${score!=null?'scored':''}">${score!=null?score+'/'+m.weight:'‚Äî'}</span></div></div>`}).join('')}</div>`}
let aiHTML='';if(isG){const as=sd.aiScore;const af=sd.aiFeedback;aiHTML=`<div class="ai-score-panel"><h4>ü§ñ AI Assessment</h4><p style="font-size:.8rem;color:var(--text-muted)">Evaluates milestones, evidence, and documentation.</p><div class="ai-score-summary"><div class="ai-total-score">${as!=null?as+'%':'‚Äî'}</div><div class="ai-breakdown">${af?'Assessment complete ‚Äî see feedback below.':'Click to get scored.'}</div><button class="run-ai-btn" id="runAiBtn" onclick="runAI()">ü§ñ Run AI Assessment</button></div>${af?`<div class="ai-feedback">${esc(af)}</div>`:''}</div>`}
document.getElementById('moduleDetail').innerHTML=`<button class="back-btn" onclick="goBack()">‚Üê Map</button><div class="detail-header"><div class="stage-icon" style="background:${stage.bg};font-size:22px;width:46px;height:46px;border-radius:12px">${stage.icon}</div><div><div style="font-size:.68rem;text-transform:uppercase;letter-spacing:2px;font-weight:800;color:${stage.color}">Stage ${STAGES.indexOf(stage)+1} ¬∑ Week ${state.currentWeek}</div><h2>${stage.name}</h2></div><div class="detail-progress-badges"><div class="progress-badge"><small>Group</small><div class="pct-val" style="color:var(--group-color)">${gp}%</div></div>${sd.aiScore!=null?`<div class="progress-badge"><small>AI</small><div class="pct-val" style="color:var(--teacher)">${sd.aiScore}%</div></div>`:''}</div></div>${ann}<div class="tabs"><button class="tab-btn ${tab==='group'?'active':''}" onclick="switchTab('group')">ü§ù Group</button><button class="tab-btn ${tab==='personal'?'active':''}" onclick="switchTab('personal')">üë§ Personal</button></div>${online}${mHTML}${aiHTML}<div class="canvas-workspace"><div class="canvas-grid" id="canvasGrid">${blocks.map((b,i)=>rB(b,i,isG)).join('')}</div><div class="add-block-area"><button class="add-block-btn" onclick="addBlock('notes')">üìù Notes</button><button class="add-block-btn" onclick="addBlock('photos')">üì∏ Photos</button><button class="add-block-btn" onclick="addBlock('checklist')">‚úÖ Checklist</button><button class="add-block-btn" onclick="addBlock('freeform')">‚úèÔ∏è Free Space</button></div></div><div class="reflection-section"><div class="reflection-card"><h4>ü™û Reflection</h4><div class="reflection-prompts"><div class="reflection-prompt"><label>What was most surprising or impactful today?</label><textarea class="block-textarea" placeholder="Your thoughts..." oninput="uRef(0,this.value)">${esc(sd.reflections[0])}</textarea></div><div class="reflection-prompt"><label>What would you do differently?</label><textarea class="block-textarea" placeholder="Your thoughts..." oninput="uRef(1,this.value)">${esc(sd.reflections[1])}</textarea></div></div></div></div>`;initDD();initRz()}
function rB(b,i,isG){const ic={notes:'üìù',photos:'üì∏',checklist:'‚úÖ',freeform:'‚úèÔ∏è'};const lb={notes:'Notes',photos:'Photos',checklist:'Checklist',freeform:'Free'};let auth='';if(isG&&b.author){const self=b.author===config.name;const c=gMC(b.author);auth=`<span class="block-author ${self?'self':'other'}" style="${!self?`background:${c}22;color:${c}`:''}">${esc(b.author)}</span>`}
let ts='';if(b.createdAt){const d=new Date(b.createdAt);ts=`<div class="block-timestamp">${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>`}
const sp=b.colSpan||(b.type==='freeform'?2:1);const hS=b.customHeight?`height:${b.customHeight}px;overflow:hidden;`:'';
let body='';if(b.type==='notes'){const h=b.customHeight?`style="height:${Math.max(50,b.customHeight-120)}px"`:'';body=`<textarea class="block-textarea" placeholder="${esc(b.placeholder||'Write...')}" oninput="uBD(${i},this.value)" ${h}>${esc(b.data||'')}</textarea>`}
else if(b.type==='freeform'){const h=b.customHeight?`style="height:${Math.max(50,b.customHeight-120)}px"`:'style="min-height:120px"';body=`<textarea class="block-textarea" placeholder="Anything goes..." ${h} oninput="uBD(${i},this.value)">${esc(b.data||'')}</textarea>`}
else if(b.type==='photos'){const p=Array.isArray(b.data)?b.data:[];body=`<div class="block-photos">${p.map((ph,pi)=>`<div class="photo-thumb"><img src="${ph}" /><button class="remove-photo" onclick="rmPh(${i},${pi})">‚úï</button></div>`).join('')}</div><input type="file" accept="image/*" multiple class="hidden-input" id="fi${i}" onchange="upPh(${i},this)" /><div class="upload-zone" onclick="document.getElementById('fi${i}').click()">üì∑ Upload</div>`}
else if(b.type==='checklist'){const it=Array.isArray(b.data)?b.data:[];body=`<div class="block-checklist">${it.map((x,ci)=>`<label class="check-item ${x.done?'checked':''}"><input type="checkbox" ${x.done?'checked':''} onchange="tCI(${i},${ci},this.checked)" /><input type="text" class="check-item-text" value="${esc(x.text)}" onchange="uCT(${i},${ci},this.value)" placeholder="..." /></label>`).join('')}</div><button class="add-check-btn" onclick="aCI(${i})">+ Add</button>`}
const lk=b.likes||[];const cm=b.comments||[];const liked=lk.includes(config.name);
return`<div class="block" data-index="${i}" draggable="true" style="grid-column:span ${sp};${hS}"><div class="block-header"><span class="drag-handle">‚†ø</span><div class="block-title"><span class="icon">${ic[b.type]}</span><span class="block-title-text" contenteditable="true" onblur="uBT(${i},this.textContent)">${esc(b.title)}</span>${auth}<span class="block-type-badge ${b.type}">${lb[b.type]}</span></div><div class="block-actions"><button class="span-toggle ${sp>=2?'active':''}" onclick="tSp(${i})">‚Üî</button><button class="block-action-btn" onclick="mvB(${i},-1)">‚Üë</button><button class="block-action-btn" onclick="mvB(${i},1)">‚Üì</button><button class="block-action-btn danger" onclick="rmB(${i})">üóë</button></div></div><div class="block-body">${body}</div>${ts}<div class="block-footer"><button class="like-btn ${liked?'liked':''}" onclick="tLk(${i})">${liked?'‚ù§Ô∏è':'ü§ç'} ${lk.length}</button><button class="comment-toggle" onclick="tCm(${i})">üí¨ ${cm.length}</button></div><div class="block-comments" id="cm_${i}"><div class="comment-list">${cm.map(c=>`<div class="comment"><div class="comment-header"><span class="comment-author ${c.isT?'teacher-comment':''}">${esc(c.author)}${c.isT?' üë©‚Äçüè´':''}</span><span class="comment-time">${c.time||''}</span></div><div class="comment-text">${esc(c.text)}</div></div>`).join('')}</div><div class="comment-input-row"><input class="comment-input" id="ci${i}" placeholder="Comment..." onkeydown="if(event.key==='Enter')aCm(${i})" /><button class="comment-send" onclick="aCm(${i})">‚Üí</button></div></div><div class="resize-handle resize-handle-bottom" data-dir="bottom" data-index="${i}"></div><div class="resize-handle resize-handle-corner" data-dir="corner" data-index="${i}"></div></div>`}
function tLk(i){const b=gAB()[i];if(!b.likes)b.likes=[];const x=b.likes.indexOf(config.name);if(x>=0)b.likes.splice(x,1);else b.likes.push(config.name);autoSave();renderDetail()}
function tCm(i){document.getElementById('cm_'+i)?.classList.toggle('open')}
function aCm(i){const inp=document.getElementById('ci'+i);const t=inp.value.trim();if(!t)return;const b=gAB()[i];if(!b.comments)b.comments=[];b.comments.push({author:config.name,text:t,time:new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),isT:state.role==='teacher'});inp.value='';autoSave();renderDetail();setTimeout(()=>document.getElementById('cm_'+i)?.classList.add('open'),50)}
function openLinkModal(mid){const bl=gAB();const sd=gWD()[state.currentStage];const ex=(sd.milestoneEvidence[mid]||[]).map(e=>e.blockId);document.getElementById('modalContainer').innerHTML=`<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal"><h3>Link Evidence</h3><p style="font-size:.82rem;color:var(--text-muted);margin-bottom:12px">Select blocks as evidence:</p>${bl.map((b,i)=>`<div class="modal-block-item ${ex.includes(b.id)?'selected':''}" onclick="this.classList.toggle('selected')" data-bid="${b.id}" data-bt="${esc(b.title)}">${b.type==='notes'?'üìù':b.type==='photos'?'üì∏':b.type==='checklist'?'‚úÖ':'‚úèÔ∏è'} ${esc(b.title)}</div>`).join('')}<div class="modal-actions"><button class="modal-close" onclick="closeModal()">Cancel</button><button class="modal-confirm" onclick="cfLink('${mid}')">Link</button></div></div></div>`}
function closeModal(){document.getElementById('modalContainer').innerHTML=''}
function cfLink(mid){const sd=gWD()[state.currentStage];sd.milestoneEvidence[mid]=Array.from(document.querySelectorAll('.modal-block-item.selected')).map(el=>({blockId:el.dataset.bid,title:el.dataset.bt}));closeModal();autoSave();renderDetail()}
function unlinkEv(mid,i){gWD()[state.currentStage].milestoneEvidence[mid].splice(i,1);autoSave();renderDetail()}
function runAI(){const btn=document.getElementById('runAiBtn');if(!btn)return;btn.className='run-ai-btn running';btn.innerHTML='‚è≥ Analyzing...';const sd=gWD()[state.currentStage];const tc=gTC().stages[state.currentStage];const bl=sd.group.blocks;setTimeout(()=>{let tot=0;let fb=[];tc.milestones.forEach(m=>{const ev=sd.milestoneEvidence[m.id]||[];const hasEv=ev.length>0;const filled=bl.filter(b=>cBP(b)>0.5).length;const ratio=Math.min(1,filled/Math.max(1,bl.length));let s;if(hasEv&&ratio>0.5){s=Math.round(m.weight*(.7+Math.random()*.3));fb.push('‚úÖ '+m.name+': Strong ('+s+'/'+m.weight+')')}else if(hasEv||ratio>0.3){s=Math.round(m.weight*(.4+Math.random()*.3));fb.push('‚ö†Ô∏è '+m.name+': Partial ('+s+'/'+m.weight+')')}else{s=Math.round(m.weight*Math.random()*.3);fb.push('‚ùå '+m.name+': Needs work ('+s+'/'+m.weight+')')};sd.milestoneScores[m.id]=s;tot+=s});const rb=sd.reflections.filter(r=>r.trim().length>20).length*2;tot=Math.min(100,tot+rb);sd.aiScore=tot;sd.aiFeedback=fb.join('\n')+'\n\nüìù Reflection bonus: +'+rb+'%\n\nOverall: '+(tot>70?'Strong progress! Great documentation.':tot>40?'Developing well. Link more evidence to milestones.':'Early stage. Focus on completing notes and uploading evidence.');autoSave();renderDetail();showToast('synced','ü§ñ Assessment done!')},2000)}
function gAB(){return gWD()[state.currentStage][state.currentTab].blocks}
function tSp(i){const b=gAB()[i];b.colSpan=(b.colSpan||1)>=2?1:2;autoSave();renderDetail()}
function addBlock(type){const bl=gAB();const isG=state.currentTab==='group';const t={notes:isG?'Notes - ('+config.name+')':'New Notes',photos:isG?'Photos - ('+config.name+')':'New Photos',checklist:isG?'Checklist - ('+config.name+')':'New Checklist',freeform:isG?'Free Space - ('+config.name+')':'Free Space'};bl.push({id:mId(),type,title:t[type],placeholder:type==='notes'?'Write...':'',author:isG?config.name:null,createdAt:new Date().toISOString(),data:type==='checklist'?[{text:'',done:false}]:type==='photos'?[]:'',colSpan:type==='freeform'?2:1,likes:[],comments:[]});autoSave();renderDetail()}
function rmB(i){const b=gAB();if(b.length<=1)return;b.splice(i,1);autoSave();renderDetail()}
function uBT(i,t){gAB()[i].title=t.trim()||'Untitled';autoSave()}
function uBD(i,v){gAB()[i].data=v;autoSave()}
function upPh(bi,inp){if(!inp.files.length)return;const b=gAB()[bi];if(!Array.isArray(b.data))b.data=[];Array.from(inp.files).forEach(f=>{const r=new FileReader();r.onload=e=>{b.data.push(e.target.result);autoSave();renderDetail()};r.readAsDataURL(f)});inp.value=''}
function rmPh(bi,pi){gAB()[bi].data.splice(pi,1);autoSave();renderDetail()}
function tCI(bi,ci,c){gAB()[bi].data[ci].done=c;autoSave();renderDetail()}
function uCT(bi,ci,t){gAB()[bi].data[ci].text=t;autoSave()}
function aCI(bi){gAB()[bi].data.push({text:'',done:false});autoSave();renderDetail()}
function uRef(i,v){gWD()[state.currentStage].reflections[i]=v;autoSave()}
function mvB(i,d){const b=gAB();const n=i+d;if(n<0||n>=b.length)return;[b[i],b[n]]=[b[n],b[i]];autoSave();renderDetail()}
function reorder(f,t){const b=gAB();const[m]=b.splice(f,1);b.splice(t,0,m);autoSave();renderDetail()}
function initDD(){const g=document.getElementById('canvasGrid');if(!g)return;g.querySelectorAll('.block[draggable]').forEach(bl=>{bl.addEventListener('dragstart',e=>{bl.classList.add('dragging');e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',bl.dataset.index)});bl.addEventListener('dragend',()=>{bl.classList.remove('dragging');document.querySelectorAll('.drag-over').forEach(b=>b.classList.remove('drag-over'))});bl.addEventListener('dragover',e=>{e.preventDefault();bl.classList.add('drag-over')});bl.addEventListener('dragleave',()=>bl.classList.remove('drag-over'));bl.addEventListener('drop',e=>{e.preventDefault();bl.classList.remove('drag-over');const f=parseInt(e.dataTransfer.getData('text/plain'));const t=parseInt(bl.dataset.index);if(f!==t)reorder(f,t)})})}
function initRz(){document.querySelectorAll('.resize-handle').forEach(h=>{h.addEventListener('dblclick',e=>{e.preventDefault();e.stopPropagation();delete gAB()[parseInt(h.dataset.index)].customHeight;autoSave();renderDetail()});h.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();const dir=h.dataset.dir;const bi=parseInt(h.dataset.index);const el=h.closest('.block');if(!el)return;el.classList.add('resizing');el.setAttribute('draggable','false');const tip=document.getElementById('resizeTooltip');tip.classList.add('show');const sY=e.clientY;const sH=el.offsetHeight;const sW=el.offsetWidth;const sX=e.clientX;function onM(ev){const dy=ev.clientY-sY;if(dir==='bottom'||dir==='corner'){const nh=Math.max(120,sH+dy);el.style.height=nh+'px';el.style.overflow='hidden';const ta=el.querySelector('.block-textarea');if(ta)ta.style.height=Math.max(50,nh-120)+'px'}if(dir==='corner'){const grid=document.getElementById('canvasGrid');if(grid){const half=(grid.offsetWidth-14)/2;if(sW+(ev.clientX-sX)>half*1.4){gAB()[bi].colSpan=2;el.style.gridColumn='span 2'}else{gAB()[bi].colSpan=1;el.style.gridColumn='span 1'}}}tip.style.left=(ev.clientX+12)+'px';tip.style.top=(ev.clientY-18)+'px';tip.textContent=el.offsetWidth+' x '+(parseInt(el.style.height)||el.offsetHeight)+'px'}function onU(){document.removeEventListener('mousemove',onM);document.removeEventListener('mouseup',onU);el.classList.remove('resizing');el.setAttribute('draggable','true');tip.classList.remove('show');const hv=parseInt(el.style.height);if(hv>100)gAB()[bi].customHeight=hv;autoSave();renderDetail()}document.addEventListener('mousemove',onM);document.addEventListener('mouseup',onU)})})}
const AIR={empathize:['Ask open-ended questions like "Tell me about a time when..."','Pay attention to what users DO, not just SAY.','Try an empathy map: Says, Thinks, Does, Feels.'],define:['Problem statement: "[User] needs [need] because [insight]"','Try "How Might We" questions!'],ideate:['QUANTITY over quality! 20 ideas in 5 minutes.','Crazy 8s: 8 boxes, 1 minute each.','SCAMPER: Substitute, Combine, Adapt, Modify, Put to use, Eliminate, Reverse.'],prototype:['Prototype needs to be TESTABLE, not perfect.','Paper prototypes work great!'],test:['Give minimal instructions and observe.','Note hesitations, confusion, and delight.'],fallback:['What stage are you on?','Design thinking is iterative!','Think from the user perspective!']};
function getAIR(){const s=state.currentStage;if(s&&AIR[s])return AIR[s][Math.floor(Math.random()*AIR[s].length)];return AIR.fallback[Math.floor(Math.random()*AIR.fallback.length)]}
function askAI(t){document.getElementById('aiInput').value=t;sendAI()}
function sendAI(){const inp=document.getElementById('aiInput');const m=inp.value.trim();if(!m)return;const msgs=document.getElementById('aiMessages');msgs.innerHTML+='<div class="ai-msg user">'+esc(m)+'</div>';inp.value='';msgs.innerHTML+='<div class="ai-msg bot" id="typing"><div class="typing-dots"><span></span><span></span><span></span></div></div>';msgs.scrollTop=msgs.scrollHeight;setTimeout(()=>{const el=document.getElementById('typing');if(el){el.innerHTML=getAIR();el.id=''}msgs.scrollTop=msgs.scrollHeight},700+Math.random()*600);document.getElementById('aiPanel').classList.add('open')}
document.getElementById('aiToggle').addEventListener('click',()=>document.getElementById('aiPanel').classList.toggle('open'));
document.getElementById('aiClose').addEventListener('click',()=>document.getElementById('aiPanel').classList.remove('open'));
document.getElementById('aiInput').addEventListener('keydown',e=>{if(e.key==='Enter')sendAI()});
setInterval(()=>{const d=document.getElementById('syncDot');const l=document.getElementById('syncLabel');d.classList.add('syncing');l.textContent='Syncing...';setTimeout(()=>{d.classList.remove('syncing');l.textContent='Synced';saveState()},1200)},30000);
(async function(){await authBootstrap();loadConfig();loadState();gWD();gTC();renderStudentMap();})();
</script>
</body>
</html>
